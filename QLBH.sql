CREATE DATABASE QLBH

USE QLBH

-- 1 Tao cac quan he va khoa
CREATE table KHACHHANG (
    MAKH CHAR(4) primary key, 
    -- TAO KHOA CHINH NGAY KHI TAO BANG, NO SE TU HIEU NOT NULL
    HOTEN varchar(40),
    DCHI varchar(50),
    SODT varchar(20),
    NGSINH smalldatetime,
    DOANHSO money,
    NGDK smalldatetime
)

SELECT name 
FROM sys.key_constraints 
WHERE parent_object_id = OBJECT_ID('KHACHHANG') 
    AND type_desc = 'PRIMARY_KEY_CONSTRAINT';

CREATE TABLE NHANVIEN(
    MANV char(4),
    HOTEN varchar(40),
    SODT varchar(20),
    NGVL smalldatetime
    CONSTRAINT PK_MANV PRIMARY KEY (MANV)
)

-- TAO KHOA CHINH SAU KHI TAO BANG, LUU Y KHOA CHINH PHAI NOT NULL MOI DC LAM KHOA CHINH
-- -- SUA MANV CHAR(4) THANH NOT NULL
-- ALTER TABLE NHANVIEN
-- ALTER COLUMN MANV char(4) NOT NULL
-- -- TAO KHOA CHO MANV TEN KHOA LA PK_MANV
-- ALTER TABLE NHANVIEN
-- ADD CONSTRAINT PK_MANV PRIMARY KEY (MANV)

CREATE TABLE SANPHAM(
    MASP char(4),
    TENSP varchar(40),
    DVT varchar(20),
    NUOCSX varchar(40),
    GIA money
    CONSTRAINT PK_MASP PRIMARY KEY (MASP)
)

CREATE TABLE HOADON (
    SOHD int,
    NGHD smalldatetime,
    MAKH char(4),
    MANV char(4),
    TRIGIA money,
    CONSTRAINT PK_SOHD PRIMARY KEY (SOHD),
    CONSTRAINT FK_HOADON_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
    CONSTRAINT FK_HOADON_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)

 
CREATE TABLE CTHD(
    SOHD int NOT NULL,
    MASP char(4) NOT NULL,
    SL INT,
    CONSTRAINT FK_CTHD_SOHD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD),
    CONSTRAINT FK_CTHD_MASP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP),
    CONSTRAINT PK_CTHD PRIMARY KEY (SOHD, MASP)
)

-- 2 THEM THUOC TINH GHICHU VARCHAR(20) VAO SANPHAM
ALTER TABLE SANPHAM
ADD GHICHU varchar(20);

-- 3 THEM THUOC TINH LOAIKH TINYINT VAO KHACHHANG
ALTER TABLE KHACHHANG
ADD LOAIKH TINYINT;

-- 4 SUA KIEU DU LIEU THUOC TINH GHICHU -> VARCHAR(100)
ALTER TABLE SANPHAM
ALTER COLUMN GHICHU varchar(100);

-- 5 XOA THUOC TINH GHICHU TRONG BANG SANPHAM 
ALTER TABLE SANPHAM
DROP COLUMN GHICHU;

-- 6 SUA KIEU DU LIEU THUOC TINH LOAIKH -> VARCHAR(50) ROI THEM “Vanglai”, “Thuong xuyen”, “Vip”,...
ALTER TABLE KHACHHANG
ALTER COLUMN LOAIKH VARCHAR(50);

-- 7 DON VI CUA SANPHAM CHI CO THE LA (“cay”,”hop”,”cai”,”quyen”,”chuc”)
ALTER TABLE SANPHAM
ADD CHECK (DVT = 'cay' OR DVT = 'hop' OR  DVT = 'cai' OR DVT = 'quyen' OR DVT = 'chuc')

ALTER TABLE SANPHAM
ADD CONSTRAINT CK_DVT CHECK (DVT = 'cay' OR DVT = 'hop')

ALTER TABLE SANPHAM
ADD CONSTRAINT CK_DVT CHECK (DVT IN ('cay', 'hop', 'cai', 'quyen', 'chuc'))

ALTER TABLE SANPHAM
DROP CONSTRAINT CK_DVT;

-- 8 GIA BAN CUA SANPHAM TU 500 TRO LEN
ALTER TABLE SANPHAM
ADD CONSTRAINT CK_GIA CHECK (GIA>=500);

-- 9 KHACH PHAI MUA IT NHAT 1 SANPHAM
ALTER TABLE HOADON
ADD CONSTRAINT CK_MUAHANG CHECK (TRIGIA>0);

-- 10 NGDK PHAI LON HON NGSINH
ALTER TABLE KHACHHANG
ADD CONSTRAINT CK_NGDK CHECK (NGDK > NGSINH);

SET DATEFORMAT DMY

-- 11 Ngày mua hàng (NGHD) của một khách hàng thành viên sẽ lớn hơn hoặc bằng ngày khách hàng đó
-- đăng ký thành viên (NGDK).
-- Bối cảnh     thêm    xoá     sửa
-- KHACHHANG     -       -       +(NGDK)
-- HOADON        +       -       +(MAKH, NGHD)

GO
CREATE TRIGGER TRG_KHACHHANG_UPDATE
ON KHACHHANG
FOR UPDATE
AS
    BEGIN
        DECLARE @MAKH CHAR(4), @NGDK smalldatetime, @NGHD smalldatetime

        -- LAY THONG TIN UPDATTE
        SELECT @NGDK = NGDK, @MAKH = MAKH 
        FROM INSERTED

        SELECT @NGHD = NGHD
        FROM HOADON 
        WHERE MAKH = @MAKH
        -- SO SANH
        IF (@NGHD < @NGDK) 
            BEGIN
                PRINT 'LOI'
                ROLLBACK TRANSACTION
            END
        ELSE
            BEGIN
                PRINT 'UPDATE KHACHHANG THANH CONG'
            END
    END

DROP TRIGGER TRG_KHACHHANG_UPDATE

GO
CREATE TRIGGER TRG_HOADON_INSERT_UPDATE_KH
ON HOADON
FOR INSERT, UPDATE
AS
    BEGIN
        DECLARE @NGDK smalldatetime, @MAKH CHAR(4), @NGHD smalldatetime
        
        -- LAY THONG TIN INSERT
        SELECT @NGHD = NGHD, @MAKH = MAKH
        FROM INSERTED

        SELECT @NGDK = NGDK
        FROM KHACHHANG
        WHERE MAKH = @MAKH

        -- SO SANH
        IF (@NGHD < @NGDK)
            BEGIN
                PRINT 'LOI DO NGHD < NGDK'
                ROLLBACK TRANSACTION
            END
        ELSE   
            BEGIN
                PRINT 'INSERT/UPDATE THANH CONG'
            END

    END

DROP TRIGGER TRG_HOADON_INSERT_UPDATE_KH

-- 12 Ngày bán hàng (NGHD) của một nhân viên phải lớn hơn hoặc bằng ngày nhân viên đó vào làm.

-- bối cảnh     thêm    xoá     sửa
-- NHANVIEN      -       -      +(NGVL)                      
-- HOADON        +       -      +(NGHD, MANV)
GO
CREATE TRIGGER TRG_NHANVIEN_UPDATE
ON NHANVIEN
FOR UPDATE
AS 
    BEGIN
        DECLARE @NGVL smalldatetime, @MANV CHAR(4), @NGHD SMALLDATETIME
        -- LAY THONG TIN UPDATE
        SELECT @NGVL = NGVL, @MANV = MANV 
        FROM INSERTED 

        SELECT @NGHD = NGHD 
        FROM HOADON
        WHERE MANV = @MANV 
        -- SO SANH
        IF (@NGVL > @NGHD)
            BEGIN 
                PRINT 'LOI'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'UPDATE THANH CONG'
            END
    END
DROP TRIGGER TRG_NHANVIEN_UPDATE


GO 
CREATE TRIGGER TRG_HOADON_INSERT_UPDATE_NV
ON HOADON
FOR INSERT, UPDATE
AS
    BEGIN
        DECLARE @NGHD SMALLDATETIME, @MANV CHAR(4), @NGVL SMALLDATETIME
        -- LAY THONG TIN INSERT, UPDATE
        SELECT @NGHD = NGHD, @MANV = MANV 
        FROM INSERTED 

        SELECT @NGVL = NGVL 
        FROM NHANVIEN
        WHERE MANV = @MANV

        IF (@NGVL > @NGHD) 
            BEGIN
                PRINT 'LOI'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'INSERT/UPDATE THANH CONG'
            END
    END
DROP TRIGGER TRG_HOADON_INSERT_UPDATE_NV

-- 13. Mỗi một hóa đơn phải có ít nhất một chi tiết hóa đơn.
-- BOI CANH     THEM    XOA     SUA
-- HOADON        -       -       -(*)
-- CTHD          -       +       -(*)

GO
CREATE TRIGGER TRG_CTHD_DEL
ON CTHD 
AFTER DELETE
AS
    BEGIN
        DECLARE @SOHD INT, @SL_CTHD INT
        -- LAY THONG TIN DELETE
        SELECT @SOHD = SOHD 
        FROM DELETED 

        SELECT @SL_CTHD = COUNT(*)
        FROM CTHD
        WHERE SOHD = @SOHD
        -- SO SANH 
        IF (@SL_CTHD = 0) 
            BEGIN
                PRINT 'LOI'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'DELETE THANH CONG'
            END
    END
DROP TRIGGER TRG_CTHD_DEL


GO
CREATE TRIGGER TRG_CTHD_DELE
ON CTHD 
AFTER DELETE
AS
    BEGIN
        DECLARE @SOHD INT, @SL_CTHD INT
        -- LAY THONG TIN DELETE
        SELECT @SOHD = SOHD 
        FROM DELETED 
        IF NOT EXISTS (
            SELECT *
            FROM CTHD
            WHERE SOHD = @SOHD
        )
            BEGIN
                PRINT 'HOA DON '+CONVERT(VARCHAR(10), @SOHD) + ' PHAI CO IT NHAT 1 CTHD'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'DELETE THANH CONG'
            END
    END
DROP TRIGGER TRG_CTHD_DELE

DELETE FROM CTHD WHERE SOHD = '1022'

-- 14. Trị giá của một hóa đơn là tổng thành tiền (số lượng*đơn giá) của các chi tiết thuộc hóa đơn đó.
-- BOI CANH     THEM    XOA     SUA
-- SANPHAM       -       -       +(GIA)
-- CTHD          +       +       +(SL)
-- HOADON        -       -       +(TRIGIA)
GO
CREATE TRIGGER TRG_CTHD_INSERT_UPDATE
ON CTHD
AFTER INSERT, UPDATE
AS
    BEGIN
        DECLARE @SOHD INT, @MASP CHAR(4), @SL INT, @TRIGIA MONEY
        -- LAY THONG TIN CUA CTHD VUA MOI THEM VAO
        SELECT @SOHD = SOHD, @MASP = MASP, @SL = SL 
        FROM INSERTED 
        -- TINH TRI GIA CUA SP MOI THEM VAO HD
        SET @TRIGIA = 0
        -- KHAI BAO CURSOR DUYET QUA CAC CTHD CUA HD
        DECLARE CUR_CTHD CURSOR 
        FOR 
            SELECT MASP, SL 
            FROM CTHD
            WHERE SOHD = @SOHD 
        
        OPEN CUR_CTHD 
        FETCH NEXT FROM CUR_CTHD 
        INTO @MASP, @SL 

        WHILE (@@FETCH_STATUS = 0)
            BEGIN
                --CONG GIA CUA TUNG SANPHAM VAO BIEN TRIGIA
                SET @TRIGIA = @TRIGIA + @SL * (SELECT GIA FROM SANPHAM WHERE MASP = @MASP)
                FETCH NEXT FROM CUR_CTHD
                INTO @MASP, @SL
            END
        CLOSE CUR_CTHD
        DEALLOCATE CUR_CTHD
        -- TIEN HANH CAP NHAT LAI TRIGIA HOADON
        UPDATE HOADON
        SET TRIGIA = @TRIGIA 
        WHERE SOHD = @SOHD
        PRINT 'CAP NHAT HD'+ CONVERT(INT, @SOHD) + ' THANH CONG'
    END

-- 15. Doanh số của một khách hàng là tổng trị giá các hóa đơn mà khách hàng thành viên đó đã mua.
-- BOI CANH     THEM    XOA     SUA
-- HOADON         +      +       +(MAKH, TRIGIA)
-- KHACHHANG      -      -       +(DOANHSO)
GO
CREATE TRIGGER TRG_HOADON_INSERT_UPDATE
ON HOADON
AFTER INSERT, UPDATE
AS
    BEGIN
        DECLARE @SOHD INT, @MAKH CHAR(4), @DOANHSO MONEY
        -- LAY THONG TIN HOADON THEM VAO
        SELECT @SOHD = SOHD, @MAKH = MAKH 
        FROM INSERTED 
        -- TINH DOANH SO BAN DAU
        SET @DOANHSO = 0
        -- KHAI BAO CURSOR DUYET QUA CAC HOADON CUA KHACHHANG
        DECLARE CUR_HD CURSOR
        FOR 
            SELECT SOHD
            FROM HOADON
            WHERE MAKH = @MAKH

        OPEN CUR_HD
        FETCH NEXT FROM CUR_HD
        INTO @SOHD

        WHILE (@@FETCH_STATUS = 0)
            BEGIN
                -- CONG TRIGIA TUNG HD VAO DOANHSO
                SET @DOANHSO = @DOANHSO + (SELECT TRIGIA FROM HOADON WHERE SOHD = @SOHD)
                FETCH NEXT FROM CUR_HD
                INTO @SOHD
            END
        CLOSE CUR_HD
        DEALLOCATE CUR_HD
        -- TIEN HANH CAP NHAT LAI DOANHSO KHACHHANG
        UPDATE KHACHHANG
        SET DOANHSO = @DOANHSO
        WHERE MAKH = @MAKH
        PRINT 'CAP NHAT DS KH '+ CONVERT(INT, @MAKH) + ' THANH CONG'
    END

-- -----------------------------
SELECT * FROM NHANVIEN
SELECT * FROM KHACHHANG
SELECT * FROM SANPHAM
SELECT * FROM HOADON
SELECT * FROM CTHD

DELETE FROM KHACHHANG
DELETE FROM SANPHAM
DELETE FROM NHANVIEN
DELETE FROM HOADON
DELETE FROM CTHD

-- DROP TABLE KHACHHANG
-- DROP TABLE NHANVIEN

----------------------------PHAN II----------------------------------------------------

-- 1 NHAP DU LIEU CHO QUAN HE
SET DATEFORMAT DMY

INSERT INTO NHANVIEN VALUES ('NV01', 'Nguyen Nhu Nhut', '0927345678', '13/04/2006')
INSERT INTO NHANVIEN VALUES ('NV02', 'Le Thi Phi Yen', '0987567390', '21/04/2006')
INSERT INTO NHANVIEN VALUES ('NV03', 'Nguyen Van B', '0997047382', '27/04/2006')
INSERT INTO NHANVIEN VALUES ('NV04', 'Ngo Thanh Tuan', '0913758498', '24/06/2006')
INSERT INTO NHANVIEN VALUES ('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '20/07/2006')

INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '8823451', '22/10/1960', 13060000, '22/07/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '908256478', '03/04/1974', 280000, '30/07/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '938776266', '12/06/1980', 3860000, '05/08/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '917325476', '09/03/1965', 250000, '02/10/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '8246108', '10/03/1950', 21000, '28/10/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '8631738', '31/12/1981', 915000, '24/11/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '916783565', '06/04/1971', 12500, '01/12/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '938435756', '10/01/1971', 365000, '13/12/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '8654763', '03/09/1979', 70000, '14/01/2007')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) 
VALUES ('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '8768904', '02/05/1983', 67500, '16/01/2007')

INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC01', 'But chi', 'cay', 'Singapore', 3000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC02', 'But chi', 'cay', 'Singapore', 5000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC03', 'But chi', 'cay', 'Viet Nam', 3500)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC04', 'But chi', 'hop', 'Viet Nam', 30000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST04', 'So tay', 'quyen', 'Thai Lan', 55000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 7000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST10', 'But long', 'cay', 'Trung Quoc', 7000)


-- VO HIEU KHOA NGOAI
ALTER TABLE HOADON
NOCHECK CONSTRAINT FK_HOADON_MAKH;

ALTER TABLE HOADON
NOCHECK CONSTRAINT FK_HOADON_MANV;
-- TAT VO HIEU KHOA NGOAI
ALTER TABLE HOADON 
WITH CHECK CHECK CONSTRAINT FK_HOADON_MAKH;

ALTER TABLE HOADON 
WITH CHECK CHECK CONSTRAINT FK_HOADON_MANV;

INSERT INTO HOADON VALUES (1001, '23/07/2006', 'KH01', 'NV01', 320000)
INSERT INTO HOADON VALUES (1002, '12/08/2006', 'KH01', 'NV02', 840000)
INSERT INTO HOADON VALUES (1003, '23/08/2006', 'KH02', 'NV01', 100000)
INSERT INTO HOADON VALUES (1004, '01/09/2006', 'KH02', 'NV01', 180000)
INSERT INTO HOADON VALUES (1005, '20/10/2006', 'KH01', 'NV02', 3800000)
INSERT INTO HOADON VALUES (1006, '16/10/2006', 'KH01', 'NV03', 2430000)
INSERT INTO HOADON VALUES (1007, '28/10/2006', 'KH03', 'NV03', 510000)
INSERT INTO HOADON VALUES (1008, '28/10/2006', 'KH01', 'NV03', 440000)
INSERT INTO HOADON VALUES (1009, '28/10/2006', 'KH03', 'NV04', 200000)
INSERT INTO HOADON VALUES (1010, '01/11/2006', 'KH01', 'NV01', 5200000)
INSERT INTO HOADON VALUES (1011, '04/11/2006', 'KH04', 'NV03', 250000)
INSERT INTO HOADON VALUES (1012, '30/11/2006', 'KH05', 'NV03', 21000)
INSERT INTO HOADON VALUES (1013, '12/12/2006', 'KH06', 'NV01', 5000)
INSERT INTO HOADON VALUES (1014, '31/12/2006', 'KH03', 'NV02', 3150000)
INSERT INTO HOADON VALUES (1015, '01/01/2007', 'KH06', 'NV01', 910000)
INSERT INTO HOADON VALUES (1016, '01/01/2007', 'KH07', 'NV02', 12500)
INSERT INTO HOADON VALUES (1017, '02/01/2007', 'KH08', 'NV03', 35000)
INSERT INTO HOADON VALUES (1018, '13/01/2007', 'KH08', 'NV03', 330000)
INSERT INTO HOADON VALUES (1019, '13/01/2007', 'KH01', 'NV03', 30000)
INSERT INTO HOADON VALUES (1020, '14/01/2007', 'KH09', 'NV04', 70000)
INSERT INTO HOADON VALUES (1021, '16/01/2007', 'KH10', 'NV03', 67500)
INSERT INTO HOADON VALUES (1022, '16/01/2007', NULL, 'NV03', 7000)
INSERT INTO HOADON VALUES (1023, '17/01/2007', NULL, 'NV01', 330000)

-- VO HIEU KHOA NGOAI
ALTER TABLE CTHD
NOCHECK CONSTRAINT FK_CTHD_MASP;

ALTER TABLE CTHD
NOCHECK CONSTRAINT FK_CTHD_SOHD;

-- TAT VO HIEU KHOA NGOAI
ALTER TABLE CTHD 
WITH CHECK CHECK CONSTRAINT FK_CTHD_MASP;

ALTER TABLE CTHD 
WITH CHECK CHECK CONSTRAINT FK_CTHD_SOHD;

INSERT INTO CTHD VALUES (1001, 'TV02', 10)
INSERT INTO CTHD VALUES (1001, 'ST01', 5)
INSERT INTO CTHD VALUES (1001, 'BC01', 5)
INSERT INTO CTHD VALUES (1001, 'BC02', 10)
INSERT INTO CTHD VALUES (1001, 'ST08', 10)
INSERT INTO CTHD VALUES (1002, 'BC04', 20)
INSERT INTO CTHD VALUES (1002, 'BB01', 20)
INSERT INTO CTHD VALUES (1002, 'BB02', 20)
INSERT INTO CTHD VALUES (1003, 'BB03', 10)
INSERT INTO CTHD VALUES (1004, 'TV01', 20)
INSERT INTO CTHD VALUES (1004, 'TV02', 10)
INSERT INTO CTHD VALUES (1004, 'TV03', 10)
INSERT INTO CTHD VALUES (1004, 'TV04', 10)
INSERT INTO CTHD VALUES (1005, 'TV05', 50)
INSERT INTO CTHD VALUES (1005, 'TV06', 50)
INSERT INTO CTHD VALUES (1006, 'TV07', 20)
INSERT INTO CTHD VALUES (1006, 'ST01', 30)
INSERT INTO CTHD VALUES (1006, 'ST02', 10)
INSERT INTO CTHD VALUES (1007, 'ST03', 10)
INSERT INTO CTHD VALUES (1008, 'ST04', 8)
INSERT INTO CTHD VALUES (1009, 'ST05', 10)
INSERT INTO CTHD VALUES (1010, 'TV07', 50)
INSERT INTO CTHD VALUES (1010, 'ST07', 50)
INSERT INTO CTHD VALUES (1010, 'ST08', 100)
INSERT INTO CTHD VALUES (1010, 'ST04', 50)
INSERT INTO CTHD VALUES (1010, 'TV03', 100)
INSERT INTO CTHD VALUES (1011, 'ST06', 50)
INSERT INTO CTHD VALUES (1012, 'ST07', 3)
INSERT INTO CTHD VALUES (1013, 'ST08', 5)
INSERT INTO CTHD VALUES (1014, 'BC02', 80)
INSERT INTO CTHD VALUES (1014, 'BB02', 100)
INSERT INTO CTHD VALUES (1014, 'BC04', 60)
INSERT INTO CTHD VALUES (1014, 'BB01', 50)
INSERT INTO CTHD VALUES (1015, 'BB02', 30)
INSERT INTO CTHD VALUES (1015, 'BB03', 7)
INSERT INTO CTHD VALUES (1016, 'TV01', 5)
INSERT INTO CTHD VALUES (1017, 'TV02', 1)
INSERT INTO CTHD VALUES (1017, 'TV03', 1)
INSERT INTO CTHD VALUES (1017, 'TV04', 5)
INSERT INTO CTHD VALUES (1018, 'ST04', 6)
INSERT INTO CTHD VALUES (1019, 'ST05', 1)
INSERT INTO CTHD VALUES (1019, 'ST06', 2)
INSERT INTO CTHD VALUES (1020, 'ST07', 10)
INSERT INTO CTHD VALUES (1021, 'ST08', 5)
INSERT INTO CTHD VALUES (1021, 'TV01', 7)
INSERT INTO CTHD VALUES (1021, 'TV02', 10)
INSERT INTO CTHD VALUES (1022, 'ST07', 1)
INSERT INTO CTHD VALUES (1023, 'ST04', 6)

--2 Tạo quan hệ SANPHAM1 chứa toàn bộ dữ liệu của quan hệ SANPHAM. Tạo quan hệ KHACHHANG1 chứa toàn bộ dữ liệu của quan hệ KHACHHANG.
SELECT * INTO SANPHAM1 FROM SANPHAM
SELECT * INTO KHACHHANG1 FROM KHACHHANG

--3 Cập nhật giá tăng 5% đối với những sản phẩm do “Thai Lan” sản xuất (cho quan hệ SANPHAM1)
UPDATE SANPHAM1
SET GIA = GIA * 1.05
WHERE NUOCSX = 'Thai Lan';

SELECT * FROM SANPHAM WHERE NUOCSX = 'Thai Lan'
SELECT * FROM SANPHAM1 WHERE NUOCSX = 'Thai Lan'

--4 Cập nhật giá giảm 5% đối với những sản phẩm do “Trung Quoc” sản xuất có giá từ 10.000 trở xuống(cho quan hệ SANPHAM1).
 
UPDATE SANPHAM1
SET GIA = GIA * 0.95
WHERE NUOCSX = 'Trung Quoc' AND GIA<=10000;

--5 Cập nhật giá trị LOAIKH là “Vip” đối với những khách hàng đăng ký thành viên trước ngày
-- 1/1/2007 có doanh số từ 10.000.000 trở lên hoặc khách hàng đăng ký thành viên từ 1/1/2007 trở về
-- sau có doanh số từ 2.000.000 trở lên (cho quan hệ KHACHHANG1).

UPDATE KHACHHANG1
SET LOAIKH = 'Vip'
WHERE (NGDK<'01/01/2007' AND DOANHSO>=10000000) OR (NGDK>='01/01/2007' AND DOANHSO>2000000)


----------------------PHAN III---------------------------------------------------
--1 IN RA SANPHAM DO TRUNG QUOC SAN XUAT

SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc';

--2 IN RA SANPHAM CO DVT LA CAY, QUYEN

SELECT MASP, TENSP FROM SANPHAM WHERE DVT = 'cay' OR DVT = 'quyen';

--3 IN RA SANPHAM CO MASP BAT DAU LA B VA KET THUC LA 01

SELECT MASP, TENSP FROM SANPHAM WHERE LEFT(MASP, 1) = 'B' AND RIGHT(MASP, 2) = '01';

SELECT MASP, TENSP FROM SANPHAM WHERE MASP LIKE 'B_01'

--4 IN RA SANPHAM CUA TRUNG QUOC, GIA TU 30000 -> 40000

SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc' AND GIA>=30000 AND GIA<=40000;

--5 IN RA SANPHAM(MASP,TENSP) do “Trung Quoc” hoAc “Thai Lan”, GIA TU 30000 -> 40000

SELECT MASP, TENSP FROM SANPHAM WHERE (NUOCSX = 'Trung Quoc' OR NUOCSX = 'Thai Lan') AND (GIA>=30000 AND GIA<=40000);

--6 In ra các số hóa đơn, trị giá hóa đơn bán ra trong ngày 1/1/2007 và ngày 2/1/2007.

SELECT SOHD, TRIGIA FROM HOADON WHERE NGHD = '1/1/2007' OR NGHD = '2/1/2007';

--7 In ra các số hóa đơn, trị giá hóa đơn trong tháng 1/2007, sắp xếp theo ngày (tăng dần) và trị giá của hóa đơn (giảm dần).

SELECT SOHD, TRIGIA FROM HOADON WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY DAY(NGHD) ASC, TRIGIA DESC;

--8 In ra danh sách các khách hàng (MAKH, HOTEN) đã mua hàng trong ngày 1/1/2007.

SELECT KHACHHANG.MAKH, KHACHHANG.HOTEN
FROM KHACHHANG
INNER JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
WHERE NGHD = '1/1/2007';

SELECT KHACHHANG.MAKH, KHACHHANG.HOTEN
FROM KHACHHANG
WHERE KHACHHANG.MAKH IN (
    SELECT HOADON.MAKH FROM HOADON WHERE HOADON.NGHD = '1/1/2007'
)

SELECT KHACHHANG.MAKH, KHACHHANG.HOTEN
FROM KHACHHANG
WHERE EXISTS (
    SELECT * FROM HOADON
    WHERE KHACHHANG.MAKH = HOADON.MAKH
    AND HOADON.NGHD = '1/1/2007'
)

--9 In ra số hóa đơn, trị giá các hóa đơn do nhân viên có tên “Nguyen Van B” lập trong ngày 28/10/2006.

SELECT HOADON.SOHD, HOADON.TRIGIA
FROM HOADON
INNER JOIN NHANVIEN ON HOADON.MANV = NHANVIEN.MANV
WHERE NHANVIEN.HOTEN = 'Nguyen Van B' AND NGHD = '28/10/2006'

--10 In ra danh sách các sản phẩm (MASP,TENSP) được khách hàng có tên “Nguyen Van A” mua trong tháng 10/2006.

SELECT SANPHAM.MASP, SANPHAM.TENSP
FROM ((HOADON 
        INNER JOIN KHACHHANG ON HOADON.MAKH = KHACHHANG.MAKH)
    INNER JOIN CTHD ON HOADON.SOHD = CTHD.SOHD) 
INNER JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
WHERE KHACHHANG.HOTEN = 'Nguyen Van A' AND MONTH(HOADON.NGHD) = 10 AND YEAR(HOADON.NGHD) = 2006;

SELECT SP.MASP, SP.TENSP
FROM SANPHAM SP
WHERE SP.MASP IN (
    SELECT CT.MASP
    FROM CTHD CT, HOADON HD, KHACHHANG KH
    WHERE HD.MAKH = KH.MAKH AND HD.SOHD = CT.SOHD
    AND KH.HOTEN = 'Nguyen Van A' AND MONTH(HD.NGHD) = 10 AND YEAR(HD.NGHD) = 2006
)


--11 Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”.

SELECT DISTINCT SOHD FROM CTHD WHERE MASP = 'BB01' OR MASP = 'BB02';

--12 Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20.
        -- IN
SELECT DISTINCT SOHD FROM CTHD WHERE MASP = 'BB01' AND (SL>=10 AND SL<=20)
OR SOHD IN (
    SELECT SOHD FROM CTHD WHERE MASP = 'BB02' AND (SL>=10 AND SL<=20)
)
        -- EXISTS
SELECT DISTINCT SOHD FROM CTHD CTHD1 WHERE CTHD1.MASP = 'BB01' AND (SL>=10 AND SL<=20)
OR EXISTS (
    SELECT SOHD FROM CTHD CTHD2 WHERE 
    CTHD1.SOHD = CTHD2.SOHD AND CTHD2.MASP = 'BB02' AND (SL>=10 AND SL<=20)
)
        --UNION
SELECT SOHD FROM CTHD WHERE MASP = 'BB01' AND SL BETWEEN 10 AND 20
UNION
SELECT SOHD FROM CTHD WHERE MASP = 'BB02' AND SL BETWEEN 10 AND 20


--13. Tìm các số hóa đơn mua cùng lúc 2 sản phẩm có mã số “BB01” và “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20.
-- phép giao

        -- INTERSECT
SELECT SOHD FROM CTHD WHERE MASP = 'BB01' AND SL BETWEEN 10 AND 20
INTERSECT
SELECT SOHD FROM CTHD WHERE MASP = 'BB02' AND SL BETWEEN 10 AND 20
        -- IN
SELECT DISTINCT SOHD FROM CTHD WHERE MASP = 'BB01' AND (SL>=10 AND SL<=20)
AND SOHD IN (
    SELECT SOHD FROM CTHD WHERE MASP = 'BB02' AND (SL>=10 AND SL<=20)
)
        -- EXISTS
SELECT DISTINCT SOHD FROM CTHD CTHD1 WHERE CTHD1.MASP = 'BB01' AND (SL>=10 AND SL<=20)
AND EXISTS (
    SELECT SOHD FROM CTHD CTHD2 WHERE 
    CTHD1.SOHD = CTHD2.SOHD AND CTHD2.MASP = 'BB02' AND (SL>=10 AND SL<=20)
)

--14. In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất hoặc các sản phẩm được bán ra trong ngày 1/1/2007.
SELECT DISTINCT SANPHAM.MASP, SANPHAM.TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' OR MASP IN (
                                            SELECT CTHD.MASP FROM HOADON
                                            INNER JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
                                            WHERE HOADON.NGHD = '1/1/2007'
                                        )

        -- EXISTS
SELECT DISTINCT S1.MASP, S1.TENSP
FROM SANPHAM S1 WHERE NUOCSX = 'Trung Quoc' 
OR EXISTS (
    SELECT CTHD.MASP FROM HOADON, CTHD
    WHERE HOADON.SOHD = CTHD.SOHD AND S1.MASP = CTHD.MASP AND HOADON.NGHD = '1/1/2007'
)

--15 In ra danh sách các sản phẩm (MASP,TENSP) không bán được.
        --JOIN
SELECT SANPHAM.MASP, SANPHAM.TENSP
FROM SANPHAM
LEFT JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
WHERE CTHD.SOHD IS NULL
        -- EXCEPT
SELECT SANPHAM.MASP, SANPHAM.TENSP 
FROM SANPHAM
WHERE MASP IN (
                SELECT SANPHAM.MASP FROM SANPHAM
                EXCEPT
                SELECT CTHD.MASP FROM CTHD
            )
        -- IN
SELECT SANPHAM.MASP, SANPHAM.TENSP 
FROM SANPHAM
WHERE SANPHAM.MASP NOT IN (SELECT CTHD.MASP FROM CTHD)

        -- EXISTS
SELECT S.MASP, S.TENSP 
FROM SANPHAM S
WHERE NOT EXISTS (
    SELECT CTHD.MASP FROM CTHD
    WHERE S.MASP = CTHD.MASP
)   

--16. In ra danh sách các sản phẩm (MASP,TENSP) không bán được trong năm 2006.

        --EXCEPT
SELECT SANPHAM.MASP, SANPHAM.TENSP 
FROM SANPHAM
WHERE MASP IN (
                SELECT SANPHAM.MASP FROM SANPHAM
                EXCEPT
                SELECT CTHD.MASP FROM CTHD
                INNER JOIN HOADON ON  CTHD.SOHD = HOADON.SOHD
                WHERE YEAR(HOADON.NGHD) = 2006
            )
            
        -- EXISTS
SELECT * 
FROM SANPHAM S1
WHERE NOT EXISTS (
    SELECT CTHD.MASP
    FROM CTHD, HOADON
    WHERE S1.MASP = CTHD.MASP AND CTHD.SOHD = HOADON.SOHD AND YEAR(HOADON.NGHD) = 2006
)

--17. In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất không bán được trong năm 2006.

SELECT SANPHAM.MASP, SANPHAM.TENSP 
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND MASP IN (
                SELECT SANPHAM.MASP FROM SANPHAM
                EXCEPT
                SELECT CTHD.MASP FROM CTHD
                INNER JOIN HOADON ON  CTHD.SOHD = HOADON.SOHD
                WHERE YEAR(HOADON.NGHD) = 2006
                )


SELECT SANPHAM.MASP, SANPHAM.TENSP 
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' 
AND NOT EXISTS (
    SELECT * 
    FROM CTHD, HOADON
    WHERE CTHD.SOHD = HOADON.SOHD AND CTHD.MASP = SANPHAM.MASP
    AND YEAR(HOADON.NGHD) = 2006
)


--18. Tìm số hóa đơn đã mua tất cả các sản phẩm do Singapore sản xuất.

SELECT CTHD.SOHD
FROM CTHD, SANPHAM
WHERE CTHD.MASP = SANPHAM.MASP AND NUOCSX = 'Singapore'
GROUP BY CTHD.SOHD
HAVING COUNT(DISTINCT CTHD.MASP) = (
                                        SELECT COUNT(SANPHAM.MASP)
                                        FROM SANPHAM
                                        WHERE NUOCSX = 'Singapore'
                                    ) --SL TAT CA SANPHAM CUA SINGAPORE

SELECT DISTINCT CT.SOHD 
FROM CTHD CT
WHERE NOT EXISTS (
                    SELECT *
                    FROM SANPHAM S
                    WHERE NUOCSX = 'Singapore' AND NOT EXISTS(
                                                                SELECT * 
                                                                FROM CTHD C
                                                                WHERE C.SOHD = CT.SOHD AND C.MASP = S.MASP
                                                            )
                )
                
SELECT * 
FROM HOADON
WHERE NOT EXISTS (
    SELECT * 
    FROM SANPHAM 
    WHERE NUOCSX = 'Singapore'
    AND MASP NOT IN (
        SELECT MASP FROM CTHD WHERE SOHD = HOADON.SOHD
    )
)

-- SAN PHAM DO SINGAPORE SAN XUAT KHONG NAM TRONG HOA DON 1002
SELECT *
FROM SANPHAM S
WHERE NUOCSX = 'Singapore' 
AND NOT EXISTS(
    SELECT * 
    FROM CTHD C
    WHERE C.SOHD = '1002'
    AND C.MASP = S.MASP
)


SELECT * FROM SANPHAM WHERE NUOCSX = 'Singapore' 
AND MASP NOT IN (
    SELECT MASP FROM CTHD WHERE SOHD = '1002'
)

--19. Tìm số hóa đơn trong năm 2006 đã mua ít nhất tất cả các sản phẩm do Singapore sản xuất.

SELECT * FROM HOADON
WHERE YEAR(NGHD) = 2006 
AND NOT EXISTS (
    SELECT * 
    FROM SANPHAM 
    WHERE NUOCSX = 'Singapore'
    AND MASP NOT IN (
        SELECT MASP FROM CTHD WHERE SOHD = HOADON.SOHD
    )
)

SELECT H.SOHD 
FROM HOADON H
WHERE YEAR(NGHD) = 2006 AND NOT EXISTS (
                                        SELECT *
                                        FROM SANPHAM S
                                        WHERE NUOCSX = 'SINGAPORE'
                                        AND NOT EXISTS (
                                                        SELECT * 
                                                        FROM CTHD C
                                                        WHERE C.SOHD = H.SOHD
                                                        AND C.MASP = S.MASP
                                                    )
                                    )


--20. Có bao nhiêu hóa đơn không phải của khách hàng đăng ký thành viên mua?
SELECT COUNT(HOADON.SOHD) AS SLHD_KoDKKH
FROM HOADON
WHERE MAKH IS NULL

--21 Có bao nhiêu sản phẩm khác nhau được bán ra trong năm 2006.

SELECT COUNT(DISTINCT CTHD.MASP)
FROM CTHD
INNER JOIN HOADON ON HOADON.SOHD = CTHD.SOHD
WHERE YEAR(HOADON.NGHD) = 2006

--22. Cho biết trị giá hóa đơn cao nhất, thấp nhất là bao nhiêu ?

SELECT MAX(HOADON.TRIGIA) MAX, MIN(HOADON.TRIGIA) MIN
FROM HOADON

--23. Trị giá trung bình của tất cả các hóa đơn được bán ra trong năm 2006 là bao nhiêu?

SELECT AVG(HOADON.TRIGIA)
FROM HOADON
WHERE YEAR(HOADON.NGHD) = 2006

--24. Tính doanh thu bán hàng trong năm 2006.
SELECT SUM(HOADON.TRIGIA)
FROM HOADON
WHERE YEAR(HOADON.NGHD) = 2006

--25. Tìm số hóa đơn có trị giá cao nhất trong năm 2006.

SELECT HOADON.SOHD
FROM HOADON
WHERE TRIGIA = (    
                    SELECT MAX(TRIGIA)  
                    FROM HOADON
                    WHERE YEAR(NGHD) = 2006
                )
AND YEAR(NGHD) = 2006

SELECT TOP 1 WITH TIES HD.SOHD
FROM HOADON HD
WHERE YEAR(NGHD) = 2006
ORDER BY TRIGIA DESC

--26. Tìm họ tên khách hàng đã mua hóa đơn có trị giá cao nhất trong năm 2006.

SELECT KHACHHANG.HOTEN
FROM KHACHHANG
INNER JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
WHERE HOADON.TRIGIA = (
                        SELECT MAX(TRIGIA)  
                        FROM HOADON
                        WHERE YEAR(NGHD) = 2006
                    )
AND YEAR(NGHD) = 2006

SELECT KHACHHANG.HOTEN
FROM KHACHHANG
INNER JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
WHERE HOADON.TRIGIA = (
                        SELECT TOP 1 HOADON.TRIGIA 
                        FROM HOADON
                        WHERE YEAR(NGHD) = 2006
                        ORDER BY TRIGIA DESC
                    )
AND YEAR(NGHD) = 2006
--27. In ra danh sách 3 khách hàng đầu tiên (MAKH, HOTEN) sắp xếp theo doanh số giảm dần.

SELECT TOP 3 MAKH, HOTEN 
FROM KHACHHANG
ORDER BY DOANHSO DESC

--28. In ra danh sách các sản phẩm (MASP, TENSP) có giá bán bằng 1 trong 3 mức giá cao nhất.

SELECT MASP, TENSP
FROM SANPHAM
WHERE GIA IN (
                SELECT DISTINCT TOP 3 GIA
                FROM SANPHAM
                ORDER BY GIA DESC
            )
         

--29. In ra danh sách các sản phẩm (MASP, TENSP) do “Thai Lan” sản xuất có giá bằng 1 trong 3 mức 
--giá cao nhất (của tất cả các sản phẩm).

SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Thai Lan' AND GIA IN (
                                        SELECT DISTINCT TOP 3 GIA
                                        FROM SANPHAM
                                        ORDER BY GIA DESC
                                    )

--30. In ra danh sách các sản phẩm (MASP, TENSP) do “Trung Quoc” sản xuất có giá bằng 1 trong 3 mức
--giá cao nhất (của sản phẩm do “Trung Quoc” sản xuất).

SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND GIA IN (
                                        SELECT DISTINCT TOP 3 GIA
                                        FROM SANPHAM
                                        WHERE NUOCSX = 'Trung Quoc'
                                        ORDER BY GIA DESC
                                    )



---------------------

SELECT MIN(TRIGIA) AS TRIGIA_MIN, MAX(TRIGIA) AS TRIGIA_MAX, AVG(TRIGIA) AS TRIGIA_AVG, SUM(TRIGIA) AS TRIGIA_SUM
FROM HOADON

SELECT COUNT(*), COUNT(SOHD), COUNT(MAKH)
FROM HOADON

SELECT TOP 2 *
FROM SANPHAM
ORDER BY GIA DESC

SELECT TOP 2 WITH TIES *
FROM SANPHAM
ORDER BY GIA DESC -- lấy luôn giá trị bằng với gia trị cuối cùng


-- KHACH HANG MUA NHIEU HOA DON NHAT

-- DEM SO HOA DON CUA MOI KHACH
SELECT DISTINCT MAKH, (
    SELECT COUNT(*)
    FROM HOADON HD2
    WHERE HD2.MAKH = HD1.MAKH
) AS  SLHD
FROM HOADON HD1
WHERE HD1.MAKH IS NOT NULL
ORDER BY SLHD DESC

--C2
SELECT MAKH, COUNT(*) AS SLHD
FROM HOADON
WHERE MAKH IS NOT NULL
GROUP BY MAKH

----------------------
-- 31 * In ra danh sách khách hàng nằm trong 3 hạng cao nhất (xếp hạng theo doanh số).
SELECT TOP 3 *
FROM KHACHHANG
ORDER BY DOANHSO DESC

SELECT TOP 3 KH.MAKH, SUM(HD.TRIGIA) AS DOANH_SO
FROM KHACHHANG KH, HOADON HD
WHERE KH.MAKH = HD.MAKH
GROUP BY KH.MAKH


-- 32. Tính tổng số sản phẩm do “Trung Quoc” sản xuất.

SELECT COUNT(MASP) AS SLSP_TQ
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'

-- 33. Tính tổng số sản phẩm của từng nước sản xuất.

SELECT NUOCSX, COUNT(MASP) AS SLSP
FROM SANPHAM
GROUP BY NUOCSX

-- 34. Với từng nước sản xuất, tìm giá bán cao nhất, thấp nhất, trung bình của các sản phẩm.

SELECT NUOCSX, MAX(GIA) AS GIA_MAX, MIN(GIA) AS MIN_GIA, AVG(GIA) AS AVG_GIA
FROM SANPHAM
GROUP BY NUOCSX

-- 35. Tính doanh thu bán hàng mỗi ngày.

SELECT NGHD, SUM(TRIGIA) AS DOANHTHU
FROM HOADON
GROUP BY NGHD

-- 36. Tính tổng số lượng của từng sản phẩm bán ra trong tháng 10/2006.

SELECT CTHD.MASP, SUM(CTHD.SL) AS SUM_SL
FROM CTHD, HOADON HD 
WHERE CTHD.SOHD = HD.SOHD AND MONTH(HD.NGHD) = 10 AND YEAR(HD.NGHD) = 2006
GROUP BY CTHD.MASP

-- 37. Tính doanh thu bán hàng của từng tháng trong năm 2006.

SELECT MONTH(NGHD) AS THANG, SUM(TRIGIA) AS DOANHTHU_THANG
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

-- 38. Tìm hóa đơn có mua ít nhất 4 sản phẩm khác nhau.

SELECT DISTINCT SOHD --, COUNT(MASP) AS SLHD
FROM CTHD
GROUP BY SOHD
HAVING COUNT(MASP) >= 4


-- 39. Tìm hóa đơn có mua 3 sản phẩm do “Viet Nam” sản xuất (3 sản phẩm khác nhau).

SELECT CT.SOHD--, COUNT(SP.MASP)
FROM CTHD CT, SANPHAM SP
WHERE CT.MASP = SP.MASP AND SP.NUOCSX = 'Viet Nam' 
GROUP BY CT.SOHD
HAVING COUNT(SP.MASP) >= 3

--C2

SELECT SOHD, COUNT(*) FROM CTHD
WHERE MASP IN (
    SELECT MASP FROM SANPHAM WHERE NUOCSX = 'Viet Nam'
)
GROUP BY SOHD
HAVING COUNT(*) >=3
-- 40. Tìm khách hàng (MAKH, HOTEN) có số lần mua hàng nhiều nhất.

SELECT TOP 1 KH.MAKH, KH.HOTEN--, COUNT(HD.SOHD)
FROM KHACHHANG KH, HOADON HD 
WHERE KH.MAKH = HD.MAKH
GROUP BY KH.MAKH, KH.HOTEN
ORDER BY COUNT(HD.SOHD) DESC

-- 41. Tháng mấy trong năm 2006, doanh số bán hàng cao nhất ?

SELECT TOP 1 MONTH(NGHD) AS THANG--, SUM(TRIGIA) AS DOANHTHU_THANG
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)
ORDER BY SUM(TRIGIA) DESC

-- 42.Tìm sản phẩm (MASP, TENSP) có tổng số lượng bán ra thấp nhất trong năm 2006.

SELECT TOP 1 SP.TENSP, CTHD.MASP--, SUM(CTHD.SL) AS SUM_SL
FROM CTHD, HOADON HD, SANPHAM SP 
WHERE SP.MASP=CTHD.MASP AND CTHD.SOHD = HD.SOHD AND YEAR(HD.NGHD) = 2006
GROUP BY CTHD.MASP, SP.TENSP
ORDER BY SUM(CTHD.SL) ASC

-- 43. *Mỗi nước sản xuất, tìm sản phẩm (MASP,TENSP) có giá bán cao nhất.
GO
CREATE VIEW GIAMAX_NUOCSX AS (
    SELECT SP.NUOCSX, MAX(SP.GIA) AS GIA_MAX
    FROM SANPHAM SP 
    GROUP BY SP.NUOCSX
)
GO
SELECT *
FROM GIAMAX_NUOCSX
JOIN SANPHAM ON SANPHAM.NUOCSX = GIAMAX_NUOCSX.NUOCSX
WHERE GIA = GIA_MAX

GO 
DROP VIEW GIAMAX_NUOCSX

--C2
SELECT *
FROM (
    SELECT SP.NUOCSX, MAX(SP.GIA) AS GIA_MAX
    FROM SANPHAM SP 
    GROUP BY SP.NUOCSX
) AS GIAMAX_NUOCSX
JOIN SANPHAM ON SANPHAM.NUOCSX = GIAMAX_NUOCSX.NUOCSX
WHERE GIA = GIA_MAX

--  C3 DUNG RANK()
SELECT NUOCSX, MASP, TENSP, GIA, 
        RANK() OVER (PARTITION BY NUOCSX ORDER BY GIA DESC) AS TEMP 
FROM SANPHAM
ORDER BY NUOCSX, GIA DESC

GO 
CREATE VIEW GIA_MAX AS 
(
SELECT MASP, TENSP, NUOCSX, GIA, 
        RANK() OVER (PARTITION BY NUOCSX ORDER BY GIA DESC) AS TEMP 
FROM SANPHAM
--ORDER BY NUOCSX, GIA DESC
)

GO
DROP VIEW GIA_MAX

GO 
SELECT * FROM GIA_MAX WHERE TEMP = '1'

-- 44. Tìm nước sản xuất sản xuất ít nhất 3 sản phẩm có giá bán khác nhau.

SELECT SP.NUOCSX, COUNT(SP.MASP) AS SL_LOAISP, COUNT( DISTINCT GIA)
FROM SANPHAM SP 
GROUP BY SP.NUOCSX
HAVING COUNT(SP.MASP) >=3 AND COUNT( DISTINCT GIA) >=3

--45. *Trong 10 khách hàng có doanh số cao nhất, tìm khách hàng có số lần mua hàng nhiều nhất.
GO
CREATE VIEW KH_DS_CAONHAT AS (
    SELECT TOP 10 *
    FROM KHACHHANG
    ORDER BY DOANHSO DESC
)

GO
SELECT TOP 1 KH.MAKH, KH.HOTEN--, COUNT(HD.SOHD)
FROM KH_DS_CAONHAT KH, HOADON HD 
WHERE KH.MAKH = HD.MAKH
GROUP BY KH.MAKH, KH.HOTEN
ORDER BY COUNT(HD.SOHD) DESC