CREATE DATABASE QLGV
USE QLGV

--1 TAO QUAN HE VA KHAI BAO KHOA

CREATE TABLE KHOA(
    MAKHOA varchar(4) not NULL,
    TENKHOA varchar(40) not null,
    NGTLAP smalldatetime,
    TRGKHOA char(4),
    CONSTRAINT PK_MAKHOA PRIMARY KEY (MAKHOA)
)

CREATE TABLE MONHOC(
    MAMH varchar(10),
    TENMH varchar(40),
    TCLT tinyint,
    TCTH tinyint,
    MAKHOA varchar(4),
    CONSTRAINT PK_MAMH PRIMARY KEY (MAMH),
    CONSTRAINT FK_MAKHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
)

CREATE TABLE DIEUKIEN(
    MAMH varchar(10),
    MAMH_TRUOC varchar(10),
    CONSTRAINT FK_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
    CONSTRAINT FK_MAMH_TRUOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
    CONSTRAINT PK_DIEUKIEN PRIMARY KEY (MAMH, MAMH_TRUOC)
)

CREATE TABLE GIAOVIEN(
    MAGV char(4) NOT NULL,
    HOTEN varchar(40),
    HOCVI varchar(10),
    HOCHAM varchar(10),
    GIOITINH varchar(3),
    NGSINH smalldatetime,
    NGVL smalldatetime,
    HESO numeric(4,2),
    MUCLUONG money,
    MAKHOA varchar(4),
    CONSTRAINT PK_MAGV PRIMARY KEY (MAGV),
    CONSTRAINT FK_MAKHOA1 FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
)
ALTER TABLE KHOA
ADD CONSTRAINT FK_TRGKHOA FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV)

CREATE TABLE LOP (
    MALOP char(3) NOT NULL,
    TENLOP varchar(40),
    TRGLOP char(5),
    SISO tinyint,
    MAGVCN char(4),
    MAKHOA varchar(4),
    CONSTRAINT PK_MALOP PRIMARY KEY (MALOP),
    CONSTRAINT FK_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
)


CREATE TABLE HOCVIEN(
    MAHV char(5) NOT NULL,
    HO varchar(40),
    TEN varchar(10),
    NGSINH smalldatetime,
    GIOITINH varchar(3),
    NOISINH varchar(40),
    MALOP char(3),
    CONSTRAINT PK_MAHV PRIMARY KEY (MAHV),
    CONSTRAINT FK_MALOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)
)

ALTER TABLE LOP
ADD CONSTRAINT FK_TRGLOP FOREIGN KEY (TRGLOP) REFERENCES HOCVIEN(MAHV)

CREATE TABLE GIANGDAY(
    MALOP char(3) NOT NULL,
    MAMH varchar(10) NOT NULL,
    MAGV char(4),
    HOCKY tinyint,
    NAM smallint,
    TUNGAY smalldatetime,
    DENNGAY smalldatetime,
    CONSTRAINT FK_MALOP1 FOREIGN KEY (MALOP) REFERENCES LOP(MALOP),
    CONSTRAINT FK_MAMH1 FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
    CONSTRAINT FK_GIAOVIEN FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV),
    CONSTRAINT FK_GIANGDAY PRIMARY KEY (MALOP, MAMH)
)

CREATE TABLE KETQUATHI(
    MAHV char(5) NOT NULL,
    MAMH varchar(10) NOT NULL,
    LANTHI tinyint NOT NULL,
    NGTHI smalldatetime,
    DIEM numeric(4,2),
    KQUA varchar(10),
    CONSTRAINT FK_HOCVIEN FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV),
    CONSTRAINT FK_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
    CONSTRAINT PK_KETQUATHI PRIMARY KEY (MAHV, MAMH, LANTHI)
)

-- THEM VAO THUOC TINH GHICHU, DIEMTB, XEPLOAI CHO QUAN HE HOCVIEN
ALTER TABLE HOCVIEN
ADD 
    GHICHU VARCHAR(100),
    DIEMTB NUMERIC(2,2),
    XEPLOAI VARCHAR(10);

--2 MAHV = MALOP(3 KI TU DAU) + STT(2 KI TU CUOI)
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_MAHV CHECK (LEN(MAHV)=5);

ALTER TABLE HOCVIEN
ADD CHECK (LEFT(MAHV, 3) = MALOP);

ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_STT CHECK (CAST(RIGHT(MAHV, 2) AS INT) <= 20);


--3 GIOITINH CHI CO 2 LUA CHON LA NAM VA NU

ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_GTGV CHECK (GIOITINH IN ('Nam', 'Nu'));

ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_GTHV CHECK (GIOITINH IN ('Nam', 'Nu'));

--4 DIEM CUA 1 LAN THI LA 0->10, LAM TRON 2 CHU SO SAU DAU PHAY
ALTER TABLE KETQUATHI
ALTER COLUMN DIEM numeric(4, 2);

ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_DIEM CHECK (DIEM >=0 AND DIEM<=10);

--5 KQUA LA 'DAT' NEU DIEM>=5, 'KHONG DAT' NEU DIEM<5
UPDATE KETQUATHI
SET KQUA = CASE
    WHEN (DIEM>=5 AND DIEM<=10) THEN 'Dat'
    ELSE 'Khong Dat'
END;

--6 HOCVIEN CHI DC THI 1 MON TOI DA 3 LAN

ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_LANTHI CHECK (LANTHI <=3);

--7 1<=HOCKY<=3

ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_HOCKY CHECK (1<=HOCKY AND HOCKY<=3)

--8 HOCVI CHI CO THE LA “CN”, “KS”, “Ths”, ”TS”, ”PTS”.
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_HOCVI CHECK (HOCVI IN ('CN', 'KS', 'Ths', 'TS', 'PTS'))

--9 Lớp trưởng của một lớp phải là học viên của lớp đó.
-- BOICANH      THEM    XOA     SUA
-- LOP           +       -       +(TRGLOP)
-- HOCVIEN       -       +       +(MALOP)
GO
CREATE TRIGGER TRG_LOP_INSERT_UPDATE
ON LOP 
FOR INSERT, UPDATE
AS
    BEGIN
        DECLARE @TRGLOP CHAR(5), @MALOP char(3), @MAHV char(5)
        -- LAY THONG TIN INSERT, UPDATE
        SELECT @TRGLOP = TRGLOP, @MALOP = MALOP 
        FROM INSERTED 

        IF NOT EXISTS (
            SELECT * 
            FROM HOCVIEN
            WHERE HOCVIEN.MALOP = @MALOP AND HOCVIEN.MAHV = @TRGLOP
        )
            BEGIN
                PRINT 'Error: Lop truong cua mot lop phai la hoc vien cua lop do'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'INSERT/UPDATE THANH CONG'
            END
    END

GO
CREATE TRIGGER TRG_HOCVIEN_DEL
ON HOCVIEN
AFTER UPDATE, DELETE
AS
    BEGIN
        DECLARE @MAHV char(5), @MALOP char(3)
        -- LAY THONG TIN HOC VIEN VUA XOA
        SELECT @MAHV = MAHV, @MALOP = MALOP 
        FROM DELETED 

        IF EXISTS (
            SELECT *
            FROM LOP
            WHERE MALOP = @MALOP AND TRGLOP = @MAHV
        )
            BEGIN
		        PRINT 'Error: Hoc vien hien tai dang la truong lop'
		        ROLLBACK TRANSACTION
	        END
        ELSE 
            BEGIN
                PRINT 'DELETE THANH CONG'
            END

    END


--10. Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”.
-- BOICANH      THEM    XOA     SUA
-- KHOA          +       -       +(TRGKHOA)
-- GIAOVIEN      -       +       +(MAKHOA, HOCVI)


GO
CREATE TRIGGER TRG_KHOA_INSERT_UPDATE
ON KHOA
FOR INSERT, UPDATE
AS
    BEGIN
        DECLARE @TRGKHOA char(4), @MAKHOA varchar(4)
        -- LAY THONG TIN VUA THEM
        SELECT @TRGKHOA = TRGKHOA, @MAKHOA = MAKHOA 
        FROM INSERTED 

        IF NOT EXISTS (
            SELECT *
            FROM GIAOVIEN
            WHERE GIAOVIEN.MAKHOA = @MAKHOA AND GIAOVIEN.MAGV = @TRGKHOA
            AND GIAOVIEN.HOCVI IN ('TS', 'PTS')
        )
            BEGIN
                PRINT 'Error: TRGKHOA PHAI LA GIAOVIEN THUOC KHOA, CO HOCVI LA TS HOAC PTS '
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'INSERT/UPDATE THANH CONG'
            END
    END

GO
CREATE TRIGGER TRG_GIAOVIEN_DEL
ON GIAOVIEN
FOR DELETE
AS
    BEGIN
        DECLARE @MAGV char(4), @MAKHOA varchar(4)
        --LAY THONG TIN GV VUA XOA
        SELECT @MAGV = MAGV, @MAKHOA = MAKHOA 
        FROM deleted

        IF EXISTS (
            SELECT *
            FROM KHOA 
            WHERE MAKHOA = @MAKHOA AND TRGKHOA = @MAGV
        )
            BEGIN
		        PRINT 'Error: Giao vien hien tai dang la truong khoa'
		        ROLLBACK TRANSACTION
	        END
        ELSE 
            BEGIN
                PRINT 'DELETE THANH CONG'
            END
    END

GO 
CREATE TRIGGER TRG_GIAOVIEN_UPDATE
ON GIAOVIEN
AFTER UPDATE
AS
    BEGIN
        DECLARE @MAGV char(4), @MAKHOA varchar(4), @HOCVI varchar(10),
                @MAGV1 char(4), @MAKHOA1 varchar(4), @HOCVI1 varchar(10)
        -- LAY THONG TIN
        SELECT @MAGV = MAGV, @MAKHOA = MAKHOA, @HOCVI = HOCVI 
        FROM INSERTED 

        SELECT @MAGV1 = MAGV, @MAKHOA1 = MAKHOA, @HOCVI1 = HOCVI 
        FROM DELETED  

        IF EXISTS (
            SELECT *
            FROM KHOA
            WHERE KHOA.MAKHOA = @MAKHOA AND KHOA.TRGKHOA = @MAGV 
        ) AND @HOCVI NOT IN ('TS', 'PTS')
            BEGIN
                PRINT 'Error: TRGKHOA PHAI LA GIAOVIEN CO HOCVI LA TS HOAC PTS '
                ROLLBACK TRANSACTION
            END
        ELSE 
            IF EXISTS (
                SELECT *
                FROM KHOA
                WHERE KHOA.MAKHOA = @MAKHOA1 AND KHOA.TRGKHOA = @MAGV1
            ) AND @MAKHOA1 <> @MAKHOA
                BEGIN
                PRINT 'Error: GIAO VIEN DANG LA TRGKHOA CUA KHOA DO, KHONG DUOC THAY DOI MAKHOA '
                ROLLBACK TRANSACTION
                END
        ELSE
            BEGIN
                PRINT 'UPDATE THANH CONG'
            END
    END

--15. Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.
-- BOICANH      THEM    XOA     SUA
-- GIANGDAY       -      -       +(DENNGAY)
-- KETQUATHI      +      -       +(NGTHI)

SELECT DISTINCT *
FROM KETQUATHI K, HOCVIEN HV
WHERE  HV.MALOP = 'K11' AND HV.MAHV = K.MAHV AND K.MAMH = 'CTRR'

GO
CREATE TRIGGER TRG_GIANGDAY_UPDATE
ON GIANGDAY
FOR UPDATE
AS
    BEGIN
        DECLARE @DENNGAY smalldatetime, @MALOP char(3), @MAMH varchar(10)
        -- LAY THONG TIN GIANGDAY VUA SUA
        SELECT @DENNGAY = DENNGAY, @MALOP = MALOP, @MAMH = MAMH 
        FROM INSERTED 
        -- NGAY KT PHAI NHO HON TAT CA NGAY THI
        IF (@DENNGAY < ALL(
            SELECT K.NGTHI
            FROM KETQUATHI K, HOCVIEN HV
            WHERE  HV.MALOP = @MALOP AND HV.MAHV = K.MAHV AND K.MAMH = @MAMH
        ))
            BEGIN
                PRINT 'UPDATE THANH CONG'
            END
        ELSE 
            BEGIN
                PRINT 'LOI: NGAY KET THUC KHONG DUOC LON HON NGAY THI MON NAY'
                ROLLBACK TRANSACTION
            END
    END


GO
CREATE TRIGGER TRG_KETQUATHI_INSERT_UPDATE
ON KETQUATHI
FOR INSERT, UPDATE
AS 
    BEGIN
        DECLARE @MAHV char(5), @MAMH varchar(10), @NGTHI smalldatetime, @NGKT smalldatetime
        -- LAY THONG TIN CUA LAN THI VUA THEM
        SELECT @MAHV = MAHV, @MAMH = MAMH, @NGTHI = NGTHI 
        FROM INSERTED 
        -- LAY THONG TIN NGAY KET THUC CUA MON CUA HOCVIEN DO
        SELECT @NGKT = GD.DENNGAY
        FROM GIANGDAY GD, HOCVIEN HV
        WHERE GD.MAMH = @MAMH AND GD.MALOP = HV.MALOP AND HV.MAHV = @MAHV
        --SO SANH
        IF (@NGTHI < @NGKT) 
            BEGIN
                PRINT 'MON HOC'+CONVERT(varchar(10), @MAMH) + ' CHUA KET THUC'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'THEM MON THI THANH CONG'
            END
    END

--16. Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.
-- BOICANH      THEM    XOA     SUA
-- GIANGDAY       +      -       -(*)

GO
CREATE TRIGGER TRIG_GIANGDAY_INSERT
ON GIANGDAY
AFTER INSERT
AS
    BEGIN
        DECLARE @MALOP char(3), @NAM smallint, @HOCKY tinyint, @SOMON INT
        -- LAY THONG TIN LOP DUOC PHAN CONG GIANGDAY VUA THEM
        SELECT @MALOP = MALOP, @NAM = NAM, @HOCKY = HOCKY 
        FROM INSERTED 
        --DEM SO MON CUA LOP TRONG HOCKY CUA NAM DO
        SELECT @SOMON = COUNT(DISTINCT MAMH)
        FROM GIANGDAY
        WHERE MALOP = @MALOP AND NAM = @NAM AND HOCKY = @HOCKY
        --SO SANH
        IF (@SOMON > 3) 
            BEGIN
                PRINT 'LOI: 1 LOP CHI DC HOC TOI DA 3 MON'
                ROLLBACK TRANSACTION
            END 
        ELSE 
            BEGIN
                PRINT 'THEM THANH CONG'
            END
    END

--17. Sỉ số của một lớp bằng với số lượng học viên thuộc lớp đó.
-- BOICANH      THEM    XOA     SUA
-- LOP           -       -       -(*)
-- HOCVIEN       +       +       +(MALOP)
GO
CREATE TRIGGER TRG_LOP
ON LOP 
FOR INSERT
AS  
    BEGIN
        UPDATE LOP
        SET SISO = 0
        WHERE LOP.MALOP = (SELECT MALOP FROM INSERTED)
    END


GO
CREATE TRIGGER TRG_HOCVIEN_INSERT
ON HOCVIEN
FOR INSERT 
AS
    BEGIN
        DECLARE @MALOP char(3)
        -- LAY THONG TIN HOC VIEN VUA THEM
        SELECT @MALOP = MALOP
        FROM INSERTED 

        UPDATE LOP 
        SET SISO = SISO + 1
        WHERE MALOP = @MALOP
    END

GO
CREATE TRIGGER TRG_HOCVIEN_UPDATE
ON HOCVIEN
FOR UPDATE
AS
    BEGIN
        DECLARE @MALOP_UP char(3), @MALOP char(3)
        -- LAY THONG TIN HOC VIEN VUA SUA
        SELECT @MALOP_UP = MALOP
        FROM INSERTED 

        SELECT @MALOP = MALOP 
        FROM DELETED 

        UPDATE LOP 
        SET SISO = SISO + 1
        WHERE MALOP = @MALOP_UP

        UPDATE LOP 
        SET SISO = SISO - 1
        WHERE MALOP = @MALOP

    END

GO
CREATE TRIGGER TRG_HOCVIEN_DELETE
ON HOCVIEN
FOR DELETE
AS
    BEGIN
        DECLARE @MALOP char(3)
        -- LAY THONG TIN HOC VIEN VUA XOA
        SELECT @MALOP = MALOP
        FROM DELETED

        UPDATE LOP 
        SET SISO = SISO - 1
        WHERE MALOP = @MALOP
    END

--18. Trong quan hệ DIEUKIEN giá trị của thuộc tính MAMH và MAMH_TRUOC trong cùng một bộ
--không được giống nhau (“A”,”A”) và cũng không tồn tại hai bộ (“A”,”B”) và (“B”,”A”).
-- BOICANH      THEM    XOA     SUA
-- DIEUKIEN       +      -       -(*)
GO
CREATE TRIGGER TRG_DIEUKIEN_INSERT_UPDATE
ON    DIEUKIEN
FOR   INSERT
AS
    BEGIN
        DECLARE @MAMH VARCHAR(10), @MAMH_TRUOC VARCHAR(10)
        -- LAY THONG TIN
        SELECT @MAMH_TRUOC = MAMH_TRUOC, @MAMH = MAMH 
        FROM INSERTED

        IF((@MAMH=@MAMH_TRUOC)OR (@MAMH IN (SELECT MAMH_TRUOC FROM DIEUKIEN WHERE MAMH=@MAMH_TRUOC))OR
                                 (@MAMH_TRUOC IN (SELECT MAMH FROM DIEUKIEN WHERE MAMH_TRUOC=@MAMH)))
            BEGIN
                  ROLLBACK TRAN
                  PRINT 'DIEUKIEN KO HOP LE'
            END
        ELSE 
            BEGIN
                PRINT 'THEM THANH CONG'
            END
    END

--19. Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau.
-- BOICANH      THEM    XOA     SUA
-- GIAOVIEN       +      -       +(HOCVI, HOCHAM, HESO, MUCLUONG)

GO
CREATE TRIGGER TRG_GIAOVIEN_INSERT_UPDATE
ON GIAOVIEN
FOR INSERT, UPDATE 
AS 
    BEGIN
        DECLARE @MAGV char(4), @HV varchar(10), @HH varchar(10), @HS numeric(4,2), @ML money
        -- LAY THONG TIN VUA THEM
        SELECT @MAGV = MAGV, @HV = HOCVI, @HH = HOCHAM, @HS = HESO, @ML = MUCLUONG
        FROM INSERTED 
        --
        IF (@ML = ALL(
            SELECT MUCLUONG FROM GIAOVIEN
            WHERE HOCVI = @HV AND HOCHAM = @HH AND HESO = @HS AND MAGV <> @MAGV
        ))
            BEGIN
                PRINT 'THEM THANH CONG'
            END
        ELSE 
            BEGIN
                PRINT 'LOI MUCLUONG'
                ROLLBACK TRANSACTION
            END
    END

--20. Học viên chỉ được thi lại (lần thi >1) khi điểm của lần thi trước đó dưới 5.
-- BOICANH      THEM    XOA     SUA
-- KETQUATHI      +      -       +(DIEM)

GO
CREATE TRIGGER TRG_KQT
ON KETQUATHI
AFTER INSERT
AS
    BEGIN
        DECLARE @MAHV char(5), @MAMH varchar(10), @LANTHI tinyint, @DIEM numeric(4,2), @DIEM_TRC numeric(4,2)
        -- LAY THONG TIN
        SELECT @MAHV = MAHV, @MAMH = MAMH, @LANTHI = LANTHI, @DIEM = DIEM 
        FROM INSERTED 

        IF (@LANTHI > 1)
            BEGIN
                SELECT @DIEM_TRC = DIEM 
                FROM KETQUATHI
                WHERE MAHV = @MAHV AND MAMH = @MAMH AND LANTHI = @LANTHI - 1

                IF (@DIEM_TRC >= 5) 
                    BEGIN
                        PRINT 'HOCVIEN DA THI DAT ROI'
                        ROLLBACK TRANSACTION
                    END
            END 
        ELSE 
            BEGIN
                PRINT 'INSERT/ UPDATE THANH CONG'
            END 
    END

GO
CREATE TRIGGER TRG_KQT_1
ON KETQUATHI
AFTER UPDATE
AS
    BEGIN
        DECLARE @MAHV char(5), @MAMH varchar(10), @LANTHI tinyint, @DIEM numeric(4,2), @DIEM_TRC numeric(4,2)
        -- LAY THONG TIN
        SELECT @MAHV = MAHV, @MAMH = MAMH, @LANTHI = LANTHI, @DIEM = DIEM 
        FROM INSERTED 
            
        IF EXISTS (
            SELECT * 
            FROM KETQUATHI 
            WHERE MAHV = @MAHV AND MAMH = @MAMH AND LANTHI = @LANTHI + 1
        ) AND @DIEM >= 5 
            BEGIN 
                PRINT 'KHONG SUA DIEM VI  CO LAN THI SAU VA DIEM CUA LAN TRUOC PHAI < 5'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN 
                PRINT 'UPDATE THANH CONG'
            END
            
    END

--21. Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước (cùng học viên, cùng môn học).
-- BOICANH      THEM    XOA     SUA
--KETQUATHI      +       -       +(NGTHI)
GO 
CREATE TRIGGER TRG_KQT_21
ON KETQUATHI
AFTER INSERT
AS 
    BEGIN 
        DECLARE @MAHV char(5), @MAMH varchar(10), @LANTHI TINYINT, @NGTHI smalldatetime, @NGTHI_TRC smalldatetime
        --LAY THONG TIN
        SELECT @MAHV = MAHV, @MAMH = MAMH, @LANTHI = LANTHI, @NGTHI = NGTHI
        FROM INSERTED 

        IF (@LANTHI > 1) 
            BEGIN
                SELECT @NGTHI_TRC = NGTHI 
                FROM KETQUATHI WHERE MAHV = @MAHV AND MAMH = @MAMH AND LANTHI = @LANTHI - 1

                IF (@NGTHI <= @NGTHI_TRC) 
                    BEGIN 
                        PRINT 'NGAY THI CUA LAN SAU PHAI LON HON NGAY THI CUA LAN TRUOC'
                        ROLLBACK TRANSACTION
                    END 
            END 
        ELSE 
            BEGIN
                PRINT 'THEM THANH CONG'
            END 

    END

GO 
CREATE TRIGGER TRG_KQT_21_1
ON KETQUATHI
AFTER update
AS 
    BEGIN 
        DECLARE @MAHV char(5), @MAMH varchar(10), @LANTHI TINYINT, @NGTHI smalldatetime, @NGTHI_TRC smalldatetime, @NGTHI_SAU smalldatetime
        --LAY THONG TIN
        SELECT @MAHV = MAHV, @MAMH = MAMH, @LANTHI = LANTHI, @NGTHI = NGTHI
        FROM INSERTED 

        SELECT @NGTHI_SAU = NGTHI 
        FROM KETQUATHI
        WHERE MAHV = @MAHV AND MAMH = @MAMH AND LANTHI = @LANTHI + 1

        SELECT @NGTHI_TRC = NGTHI 
        FROM KETQUATHI
        WHERE MAHV = @MAHV AND MAMH = @MAMH AND LANTHI = @LANTHI - 1

        IF (@NGTHI <= @NGTHI_TRC OR @NGTHI >= @NGTHI_SAU) 
            BEGIN
                PRINT 'NGAY THI CUA LAN SAU PHAI LON HON NGAY THI CUA LAN TRUOC'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'UPDATE THANH CONG'
            END 

    END
--22. Học viên chỉ được thi những môn mà lớp của học viên đó đã học xong.
-- BOICANH      THEM    XOA     SUA
-- GIANGDAY       -      -       +(DENNGAY)
-- KETQUATHI      +      -       +(NGTHI)

SELECT DISTINCT *
FROM KETQUATHI K, HOCVIEN HV
WHERE  HV.MALOP = 'K11' AND HV.MAHV = K.MAHV AND K.MAMH = 'CTRR'

GO
CREATE TRIGGER TRG_GIANGDAY_UPDATE
ON GIANGDAY
FOR UPDATE
AS
    BEGIN
        DECLARE @DENNGAY smalldatetime, @MALOP char(3), @MAMH varchar(10)
        -- LAY THONG TIN GIANGDAY VUA SUA
        SELECT @DENNGAY = DENNGAY, @MALOP = MALOP, @MAMH = MAMH 
        FROM INSERTED 
        -- NGAY KT PHAI NHO HON TAT CA NGAY THI
        IF (@DENNGAY < ALL(
            SELECT K.NGTHI
            FROM KETQUATHI K, HOCVIEN HV
            WHERE  HV.MALOP = @MALOP AND HV.MAHV = K.MAHV AND K.MAMH = @MAMH
        ))
            BEGIN
                PRINT 'UPDATE THANH CONG'
            END
        ELSE 
            BEGIN
                PRINT 'LOI: LOP CHUA HOC XONG MON NAY'
                ROLLBACK TRANSACTION
            END
    END


GO
CREATE TRIGGER TRG_KETQUATHI_INSERT_UPDATE
ON KETQUATHI
FOR INSERT, UPDATE
AS 
    BEGIN
        DECLARE @MAHV char(5), @MAMH varchar(10), @NGTHI smalldatetime, @NGKT smalldatetime
        -- LAY THONG TIN CUA LAN THI VUA THEM
        SELECT @MAHV = MAHV, @MAMH = MAMH, @NGTHI = NGTHI 
        FROM INSERTED 
        -- LAY THONG TIN NGAY KET THUC CUA MON CUA HOCVIEN DO
        SELECT @NGKT = GD.DENNGAY
        FROM GIANGDAY GD, HOCVIEN HV
        WHERE GD.MAMH = @MAMH AND GD.MALOP = HV.MALOP AND HV.MAHV = @MAHV
        --SO SANH
        IF (@NGTHI < @NGKT) 
            BEGIN
                PRINT 'MON HOC'+CONVERT(varchar(10), @MAMH) + ' CHUA KET THUC'
                ROLLBACK TRANSACTION
            END
        ELSE 
            BEGIN
                PRINT 'THEM MON THI THANH CONG'
            END
    END


--23. Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học (sau khi học
--xong những môn học phải học trước mới được học những môn liền sau).
-- BOICANH      THEM    XOA     SUA
-- GIANGDAY       +      -       -(*)

GO
CREATE TRIGGER TRG_GIANGDAY_INS 
ON GIANGDAY
FOR INSERT 
AS
    BEGIN 
        DECLARE @MAMH varchar(10), @MALOP char(3), @TUNGAY smalldatetime, @MAMH_TRUOC varchar(10)
        -- LAY THONG TIN
        SELECT @MAMH = MAMH, @MALOP = MALOP, @TUNGAY = TUNGAY
        FROM INSERTED 

        SELECT @MAMH_TRUOC = MAMH_TRUOC 
        FROM DIEUKIEN
        WHERE MAMH = @MAMH

        IF EXISTS (
            SELECT MAMH_TRUOC 
            FROM DIEUKIEN
            WHERE MAMH = @MAMH
        ) AND (
            SELECT DENNGAY 
            FROM GIANGDAY 
            WHERE MAMH = @MAMH_TRUOC AND MALOP = @MALOP
        ) > @TUNGAY 
            BEGIN
                PRINT 'LOI: PHAI HOC XONG MON TRUOC MOI DUOC HOC MON NAY'
                ROLLBACK TRANSACTION
            END 
        ELSE 
            BEGIN 
                PRINT 'THEM THANH CONG'
            END
    END

--24. Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách.
-- BOICANH      THEM    XOA     SUA
-- GIANGDAY      +       -       +(MAGV)

GO
CREATE TRIGGER INSERT_GIANGDAY_C24
ON GIANGDAY
FOR INSERT, UPDATE
AS
    BEGIN 
        DECLARE @MAKHOA1    CHAR(4), @MAKHOA2    CHAR(4)

        SELECT @MAKHOA1 = B.MAKHOA, @MAKHOA2 = C.MAKHOA 
        FROM INSERTED A, MONHOC B, GIAOVIEN C
        WHERE A.MAMH = B.MAMH AND A.MAGV = C.MAGV
        
        IF (@MAKHOA1 <> @MAKHOA2) 
            BEGIN 
                PRINT 'MAMH PHAI THUOC KHOA GIAO VIEN PHU TRACH'
                ROLLBACK TRAN
            END
        ELSE
            PRINT 'SUCCESSFUL'
    END


--------------------------------------------------------
SELECT * FROM LOP
SELECT * FROM HOCVIEN
SELECT * FROM DIEUKIEN
SELECT * FROM GIANGDAY
SELECT * FROM GIAOVIEN
SELECT * FROM KETQUATHI
SELECT * FROM KHOA
SELECT * FROM MONHOC

DELETE FROM HOCVIEN
DELETE FROM LOP
DELETE FROM DIEUKIEN
DELETE FROM GIANGDAY
DELETE FROM GIAOVIEN
DELETE FROM KETQUATHI
DELETE FROM KHOA
DELETE FROM MONHOC

--------------------------------------------------------------------------------
-- NHAP DU LIEU QLGV
SET DATEFORMAT DMY

-- VO HIEU KHOA NGOAI
ALTER TABLE KHOA
NOCHECK CONSTRAINT FK_TRGKHOA;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE KHOA
WITH CHECK CHECK CONSTRAINT FK_TRGKHOA;

INSERT INTO KHOA VALUES ('KHMT', 'Khoa hoc may tinh', '07/06/2005', 'GV01')
INSERT INTO KHOA VALUES ('HTTT', 'He thong thong tin', '07/06/2005', 'GV02')
INSERT INTO KHOA VALUES ('CNPM', 'Cong nghe phan mem', '07/06/2005', 'GV04')
INSERT INTO KHOA VALUES ('MTT', 'Mang va truyen thong', '20/10/2005', 'GV03')
INSERT INTO KHOA VALUES ('KTMT', 'Ky thuat may tinh', '20/12/2005', Null)

-- VO HIEU KHOA NGOAI
ALTER TABLE LOP
NOCHECK CONSTRAINT FK_TRGLOP;
ALTER TABLE LOP
NOCHECK CONSTRAINT FK_KHOA;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE LOP
WITH CHECK CHECK CONSTRAINT FK_TRGLOP;
ALTER TABLE LOP
WITH CHECK CHECK CONSTRAINT FK_KHOA;

INSERT INTO LOP(MALOP, TENLOP, TRGLOP, SISO, MAGVCN) VALUES ('K11', 'Lop 1 khoa 1', 'K1108', 11, 'GV07')
INSERT INTO LOP(MALOP, TENLOP, TRGLOP, SISO, MAGVCN) VALUES ('K12', 'Lop 2 khoa 1', 'K1205', 12, 'GV09')
INSERT INTO LOP(MALOP, TENLOP, TRGLOP, SISO, MAGVCN) VALUES ('K13', 'Lop 3 khoa 1', 'K1305', 12, 'GV14')

-- VO HIEU KHOA NGOAI
ALTER TABLE MONHOC
NOCHECK CONSTRAINT FK_MAKHOA;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE MONHOC
WITH CHECK CHECK CONSTRAINT FK_MAKHOA;

INSERT INTO MONHOC VALUES ('THDC', 'Tin hoc dai cuong', 4, 1, 'KHMT')
INSERT INTO MONHOC VALUES ('CTRR', 'Cau truc roi rac', 5, 0, 'KHMT')
INSERT INTO MONHOC VALUES ('CSDL', 'Co so du lieu', 3, 1, 'HTTT')
INSERT INTO MONHOC VALUES ('CTDLGT', 'Cau truc du lieu va giai thuat', 3, 1, 'KHMT')
INSERT INTO MONHOC VALUES ('PTTKTT', 'Phan tich thiet ke thuat toan', 3, 0, 'KHMT')
INSERT INTO MONHOC VALUES ('DHMT', 'Do hoa may tinh', 3, 1, 'KHMT')
INSERT INTO MONHOC VALUES ('KTMT', 'Kien truc may tinh', 3, 0, 'KTMT')
INSERT INTO MONHOC VALUES ('TKCSDL', 'Thiet ke co so du lieu', 3, 1, 'HTTT')
INSERT INTO MONHOC VALUES ('PTTKHTTT', 'Phan tich thiet ke he thong thong tin', 4, 1, 'HTTT')
INSERT INTO MONHOC VALUES ('HDH', 'He dieu hanh', 4, 0, 'KTMT')
INSERT INTO MONHOC VALUES ('NMCNPM', 'Nhap mon cong nghe phan mem', 3, 0, 'CNPM')
INSERT INTO MONHOC VALUES ('LTCFW', 'Lap trinh C for win', 3, 1, 'CNPM')
INSERT INTO MONHOC VALUES ('LTHDT', 'Lap trinh huong doi tuong', 3, 1, 'CNPM')

-- VO HIEU KHOA NGOAI
ALTER TABLE GIANGDAY
NOCHECK CONSTRAINT FK_GIAOVIEN, FK_MALOP1, FK_MAMH1;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE GIANGDAY
WITH CHECK CHECK CONSTRAINT FK_GIAOVIEN, FK_MALOP1, FK_MAMH1;

INSERT INTO GIANGDAY VALUES ('K11', 'THDC', 'GV07', 1, 2006, '02/01/2006', '12/05/2006')
INSERT INTO GIANGDAY VALUES ('K12', 'THDC', 'GV06', 1, 2006, '02/01/2006', '12/05/2006')
INSERT INTO GIANGDAY VALUES ('K13', 'THDC', 'GV15', 1, 2006, '02/01/2006', '12/05/2006')
INSERT INTO GIANGDAY VALUES ('K11', 'CTRR', 'GV02', 1, 2006, '09/01/2006', '17/05/2006')
INSERT INTO GIANGDAY VALUES ('K12', 'CTRR', 'GV02', 1, 2006, '09/01/2006', '17/05/2006')
INSERT INTO GIANGDAY VALUES ('K13', 'CTRR', 'GV08', 1, 2006, '09/01/2006', '17/05/2006')
INSERT INTO GIANGDAY VALUES ('K11', 'CSDL', 'GV05', 2, 2006, '01/06/2006', '15/07/2006')
INSERT INTO GIANGDAY VALUES ('K12', 'CSDL', 'GV09', 2, 2006, '01/06/2006', '15/07/2006')
INSERT INTO GIANGDAY VALUES ('K13', 'CTDLGT', 'GV15', 2, 2006, '01/06/2006', '15/07/2006')
INSERT INTO GIANGDAY VALUES ('K13', 'CSDL', 'GV05', 3, 2006, '01/08/2006', '15/12/2006')
INSERT INTO GIANGDAY VALUES ('K13', 'DHMT', 'GV07', 3, 2006, '01/08/2006', '15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11', 'CTDLGT', 'GV15', 3, 2006, '01/08/2006', '15/12/2006')
INSERT INTO GIANGDAY VALUES ('K12', 'CTDLGT', 'GV15', 3, 2006, '01/08/2006', '15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11', 'HDH', 'GV04', 1, 2007, '02/01/2007', '18/02/2007')
INSERT INTO GIANGDAY VALUES ('K12', 'HDH', 'GV04', 1, 2007, '02/01/2007', '20/03/2007')
INSERT INTO GIANGDAY VALUES ('K11', 'DHMT', 'GV07', 1, 2007, '18/02/2007', '20/03/2007')

-- VO HIEU KHOA NGOAI
ALTER TABLE GIAOVIEN
NOCHECK CONSTRAINT FK_MAKHOA1;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE GIAOVIEN
WITH CHECK CHECK CONSTRAINT FK_MAKHOA1;

INSERT INTO GIAOVIEN VALUES ('GV01', 'Ho Thanh Son', 'PTS', 'GS', 'Nam', '02/05/1950', '11/01/2004', 5, 2250000, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV02', 'Tran Tam Thanh', 'TS', 'PGS', 'Nam', '17/12/1965', '20/04/2004', 4.5, 2025000, 'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV03', 'Do Nghiem Phung', 'TS', 'GS', 'Nu', '01/08/1950', '23/09/2004', 4, 1800000, 'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV04', 'Tran Nam Son', 'TS', 'PGS', 'Nam', '22/02/1961', '12/01/2005', 4.5, 2025000, 'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV05', 'Mai Thanh Danh', 'ThS', 'GV', 'Nam', '12/03/1958', '12/01/2005', 3, 1350000, 'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV06', 'Tran Doan Hung', 'TS', 'GV', 'Nam', '11/03/1953', '12/01/2005', 4.5, 2025000, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV07', 'Nguyen Minh Tien', 'ThS', 'GV', 'Nam', '23/11/1971', '01/03/2005', 4, 1800000, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV08', 'Le Thi Tran', 'KS', Null, 'Nu', '26/03/1974', '01/03/2005', 1.69, 760500, 'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV09', 'Nguyen To Lan', 'ThS', 'GV', 'Nu', '31/12/1966', '01/03/2005', 4, 1800000, 'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV10', 'Le Tran Anh Loan', 'KS', Null, 'Nu', '17/07/1972', '01/03/2005', 1.86, 837000, 'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV11', 'Ho Thanh Tung', 'CN', 'GV', 'Nam', '12/01/1980', '15/05/2005', 2.67, 1201500, 'MTT')
INSERT INTO GIAOVIEN VALUES ('GV12', 'Tran Van Anh', 'CN', Null, 'Nu', '29/03/1981', '15/05/2005', 1.69, 760500, 'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV13', 'Nguyen Linh Dan', 'CN', Null, 'Nu', '23/05/1980', '15/05/2005', 1.69, 760500, 'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV14', 'Truong Minh Chau', 'ThS', 'GV', 'Nu', '30/11/1976', '15/05/2005', 3, 1350000, 'MTT')
INSERT INTO GIAOVIEN VALUES ('GV15', 'Le Ha Thanh', 'ThS', 'GV', 'Nam', '04/05/1978', '15/05/2005', 3, 1350000, 'KHMT')

-- VO HIEU KHOA NGOAI
ALTER TABLE DIEUKIEN
NOCHECK CONSTRAINT FK_MAMH;

ALTER TABLE DIEUKIEN
NOCHECK CONSTRAINT FK_MAMH_TRUOC;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE DIEUKIEN
WITH CHECK CHECK CONSTRAINT FK_MAMH;

ALTER TABLE DIEUKIEN
WITH CHECK CHECK CONSTRAINT FK_MAMH_TRUOC;

INSERT INTO DIEUKIEN VALUES ('CSDL', 'CTRR')
INSERT INTO DIEUKIEN VALUES ('CSDL', 'CTDLGT')
INSERT INTO DIEUKIEN VALUES ('CTDLGT', 'THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT', 'THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT', 'CTDLGT')
INSERT INTO DIEUKIEN VALUES ('DHMT', 'THDC')
INSERT INTO DIEUKIEN VALUES ('LTHDT', 'THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKHTTT', 'CSDL')


-- VO HIEU KHOA NGOAI
ALTER TABLE KETQUATHI
NOCHECK CONSTRAINT FK_HOCVIEN;

ALTER TABLE KETQUATHI
NOCHECK CONSTRAINT FK_MONHOC;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE KETQUATHI
WITH CHECK CHECK CONSTRAINT FK_HOCVIEN;

ALTER TABLE KETQUATHI
WITH CHECK CHECK CONSTRAINT FK_MONHOC;

INSERT INTO KETQUATHI VALUES ('K1101', 'CSDL', 1, '20/07/2006', 10, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1101', 'CTDLGT', 1, '28/12/2006', 9, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1101', 'THDC', 1, '20/05/2006', 9, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1101', 'CTRR', 1, '13/05/2006', 9.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CSDL', 1, '20/07/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CSDL', 2, '20/07/2006', 4.25, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CSDL', 3, '10/08/2006', 4.5, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CTDLGT', 1, '28/12/2006', 4.5, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CTDLGT', 2, '05/01/2007', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CTDLGT', 3, '15/01/2007', 6, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'THDC', 1, '20/05/2006', 5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1102', 'CTRR', 1, '13/05/2006', 7, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1103', 'CSDL', 1, '20/07/2006', 3.5, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1103', 'CSDL', 2, '27/07/2006', 8.25, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1103', 'CTDLGT', 1, '28/12/2006', 7, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1103', 'THDC', 1, '20/05/2006', 8, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1103', 'CTRR', 1, '13/05/2006', 6.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1104', 'CSDL', 1, '20/07/2006', 3.75, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104', 'CTDLGT', 1, '28/12/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104', 'THDC', 1, '20/05/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104', 'CTRR', 1, '13/05/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104', 'CTRR', 2, '20/05/2006', 3.5, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104', 'CTRR', 3, '30/06/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1201', 'CSDL', 1, '20/07/2006', 6, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1201', 'CTDLGT', 1, '28/12/2006', 5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1201', 'THDC', 1, '20/05/2006', 8.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1201', 'CTRR', 1, '13/05/2006', 9, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'CSDL', 1, '20/07/2006', 8, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'CTDLGT', 1, '28/12/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'CTDLGT', 2, '05/01/2007', 5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'THDC', 1, '20/05/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'THDC', 2, '27/05/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'CTRR', 1, '13/05/2006', 3, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'CTRR', 2, '20/05/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202', 'CTRR', 3, '30/06/2006', 6.25, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1203', 'CSDL', 1, '20/07/2006', 9.25, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1203', 'CTDLGT', 1, '28/12/2006', 9.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1203', 'THDC', 1, '20/05/2006', 10, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1203', 'CTRR', 1, '13/05/2006', 10, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1204', 'CSDL', 1, '20/07/2006', 8.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1204', 'CTDLGT', 1, '28/12/2006', 6.75, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1204', 'THDC', 1, '20/05/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1204', 'CTRR', 1, '13/05/2006', 6, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1301', 'CSDL', 1, '20/12/2006', 4.25, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1301', 'CTDLGT', 1, '25/07/2006', 8, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1301', 'THDC', 1, '20/05/2006', 7.75, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1301', 'CTRR', 1, '13/05/2006', 8, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1302', 'CSDL', 1, '20/12/2006', 6.75, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1302', 'CTDLGT', 1, '25/07/2006', 5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1302', 'THDC', 1, '20/05/2006', 8, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1302', 'CTRR', 1, '13/05/2006', 8.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'CSDL', 1, '20/12/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'CTDLGT', 1, '25/07/2006', 4.5, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'CTDLGT', 2, '07/08/2006', 4, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'CTDLGT', 3, '15/08/2006', 4.25, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'THDC', 1, '20/05/2006', 4.5, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'CTRR', 1, '13/05/2006', 3.25, 'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303', 'CTRR', 2, '20/05/2006', 5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1304', 'CSDL', 1, '20/12/2006', 7.75, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1304', 'CTDLGT', 1, '25/07/2006', 9.75, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1304', 'THDC', 1, '20/05/2006', 5.5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1304', 'CTRR', 1, '13/05/2006', 5, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1305', 'CSDL', 1, '20/12/2006', 9.25, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1305', 'CTDLGT', 1, '25/07/2006', 10, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1305', 'THDC', 1, '20/05/2006', 8, 'Dat')
INSERT INTO KETQUATHI VALUES ('K1305', 'CTRR', 1, '13/05/2006', 10, 'Dat')

-- VO HIEU KHOA NGOAI
ALTER TABLE HOCVIEN
NOCHECK CONSTRAINT FK_MALOP;

-- BO VO HIEU KHOA NGOAI
ALTER TABLE HOCVIEN
WITH CHECK CHECK CONSTRAINT FK_MALOP;

INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1102', 'Tran Ngoc', 'Han', '14/03/1986', 'Nu', 'Kien Giang', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1101', 'Nguyen Van', 'A', '27/01/1986', 'Nam', 'TpHCM', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1103', 'Ha Duy', 'Lap', '18/04/1986', 'Nam', 'Nghe An', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1104', 'Tran Ngoc', 'Linh', '30/03/1986', 'Nu', 'Tay Ninh', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1105', 'Tran Minh', 'Long', '27/02/1986', 'Nam', 'TpHCM', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1106', 'Le Nhat', 'Minh', '24/01/1986', 'Nam', 'TpHCM', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1107', 'Nguyen Nhu', 'Nhut', '27/01/1986', 'Nam', 'Ha Noi', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1108', 'Nguyen Manh', 'Tam', '27/02/1986', 'Nam', 'Kien Giang', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1109', 'Phan Thi Thanh', 'Tam', '27/01/1986', 'Nu', 'Vinh Long', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1110', 'Le Hoai', 'Thuong', '05/02/1986', 'Nu', 'Can Tho', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1111', 'Le Ha', 'Vinh', '25/12/1986', 'Nam', 'Vinh Long', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1201', 'Nguyen Van', 'B', '11/02/1986', 'Nam', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1202', 'Nguyen Thi Kim', 'Duyen', '18/01/1986', 'Nu', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1203', 'Tran Thi Kim', 'Duyen', '17/09/1986', 'Nu', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1204', 'Truong My', 'Hanh', '19/05/1986', 'Nu', 'Dong Nai', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1205', 'Nguyen Thanh', 'Nam', '17/04/1986', 'Nam', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1206', 'Nguyen Thi Truc', 'Thanh', '04/03/1986', 'Nu', 'Kien Giang', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1207', 'Tran Thi Bich', 'Thuy', '08/02/1986', 'Nu', 'Nghe An', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1208', 'Huynh Thi Kim', 'Trieu', '08/04/1986', 'Nu', 'Tay Ninh', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1209', 'Pham Thanh', 'Trieu', '23/02/1986', 'Nam', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1210', 'Ngo Thanh', 'Tuan', '14/02/1986', 'Nam', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1211', 'Do Thi', 'Xuan', '09/03/1986', 'Nu', 'Ha Noi', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1212', 'Le Thi Phi', 'Yen', '12/03/1986', 'Nu', 'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1301', 'Nguyen Thi Kim', 'Cuc', '09/06/1986', 'Nu', 'Kien Giang', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1302', 'Truong Thi My', 'Hien', '18/03/1986', 'Nu', 'Nghe An', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1303', 'Le Duc', 'Hien', '21/03/1986', 'Nam', 'Tay Ninh', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1304', 'Le Quang', 'Hien', '18/04/1986', 'Nam', 'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1305', 'Le Thi', 'Huong', '27/03/1986', 'Nu', 'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1306', 'Nguyen Thai', 'Huu', '30/03/1986', 'Nam', 'Ha Noi', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1307', 'Tran Minh', 'Man', '28/05/1986', 'Nam', 'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1308', 'Nguyen Hieu', 'Nghia', '08/04/1986', 'Nam', 'Kien Giang', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1309', 'Nguyen Trung', 'Nghia', '18/01/1987', 'Nam', 'Nghe An', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1310', 'Tran Thi Hong', 'Tham', '22/04/1986', 'Nu', 'Tay Ninh', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1311', 'Tran Minh', 'Thuc', '04/04/1986', 'Nam', 'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES ('K1312', 'Nguyen Thi Kim', 'Yen', '07/09/1986', 'Nu', 'TpHCM', 'K13')


--------------------------------------------------------------------------------
--11. Học viên ít nhất là 18 tuổi.

ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_TUOIHV CHECK (YEAR(CURDATE()) - YEAR(NGSINH) >=18);

--12. Giảng dạy một môn học ngày bắt đầu (TUNGAY) phải nhỏ hơn ngày kết thúc (DENNGAY).

ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_NGAYDAY CHECK (TUNGAY < DENNGAY);

--13. Giáo viên khi vào làm ít nhất là 22 tuổi.

ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_TUOIGV CHECK (YEAR(CURDATE()) - YEAR(NGSINH) >=22);

--14. Tất cả các môn học đều có số tín chỉ lý thuyết và tín chỉ thực hành chênh lệch nhau không quá 3.

ALTER TABLE MONHOC
ADD CONSTRAINT CK_TC CHECK (ABS(TCLT - TCTH) <= 3);

--------------------------------PHAN II-----------------------------------------------
--1 Tăng hệ số lương thêm 0.2 cho những giáo viên là trưởng khoa.

UPDATE GIAOVIEN
SET HESO = HESO + 0.2
WHERE GIAOVIEN.MAGV IN (
    SELECT KHOA.TRGKHOA FROM KHOA
    WHERE KHOA.TRGKHOA IS NOT NULL
)

--2. Cập nhật giá trị điểm trung bình tất cả các môn học (DIEMTB) của mỗi học viên (tất cả các môn
--học đều có hệ số 1 và nếu học viên thi một môn nhiều lần, chỉ lấy điểm của lần thi sau cùng).

UPDATE HOCVIEN 
SET DIEMTB = (SELECT AVG(DIEM) 
                FROM KETQUATHI K1 
                WHERE LANTHI = (SELECT MAX(LANTHI) 
                                FROM KETQUATHI K2 
                                WHERE (K1.MAHV = K2.MAHV AND K1.MAMH = K2.MAMH) 
                                GROUP BY MAHV,MAMH) 
                GROUP BY MAHV 
                HAVING MAHV = HOCVIEN.MAHV) 

--3. Cập nhật giá trị cho cột GHICHU là “Cam thi” đối với trường hợp: học viên có một môn bất kỳ thi lần thứ 3 dưới 5 điểm.

UPDATE HOCVIEN
SET GHICHU = 'Cam thi'
WHERE MAHV IN (
    SELECT K1.MAHV
    FROM KETQUATHI K1
    WHERE K1.LANTHI = 3 AND DIEM < 5
)

--4. Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN như sau:
--o Nếu DIEMTB >= 9 thì XEPLOAI =”XS”
--o Nếu 8 <= DIEMTB < 9 thì XEPLOAI = “G”
--o Nếu 6.5 <= DIEMTB < 8 thì XEPLOAI = “K”
--o Nếu 5 <= DIEMTB < 6.5 thì XEPLOAI = “TB”
--o Nếu DIEMTB < 5 thì XEPLOAI = ”Y”

UPDATE HOCVIEN
SET XEPLOAI = (
    CASE 
        WHEN DIEMTB >= 9 THEN 'XS'
        WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN 'G'
        WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN 'K'
        WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
        WHEN DIEMTB < 5 THEN 'Y'
        ELSE NULL
    END
)

--------------------------------PHAN III-----------------------------------------------
--1. In ra danh sách (mã học viên, họ tên, ngày sinh, mã lớp) lớp trưởng của các lớp.

SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN
INNER JOIN LOP ON HOCVIEN.MAHV = LOP.TRGLOP;

--2. In ra bảng điểm khi thi (mã học viên, họ tên , lần thi, điểm số) môn CTRR của lớp “K12”, sắp xếp theo tên, họ học viên.

SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, KETQUATHI.LANTHI, KETQUATHI.DIEM
FROM KETQUATHI
INNER JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE LEFT(KETQUATHI.MAHV, 3) = 'K12' AND KETQUATHI.MAMH = 'CTRR'
ORDER BY TEN, HO;

--3. In ra danh sách những học viên (mã học viên, họ tên) và những môn học mà học viên đó thi lần thứ nhất đã đạt.

SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN, KETQUATHI.MAMH
FROM KETQUATHI
INNER JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE KETQUATHI.LANTHI = 1 AND KETQUATHI.KQUA = 'Dat';

--4. In ra danh sách học viên (mã học viên, họ tên) của lớp “K11” thi môn CTRR không đạt (ở lần thi 1).

SELECT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM KETQUATHI
INNER JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE LEFT(KETQUATHI.MAHV, 3) = 'K11' AND KETQUATHI.MAMH = 'CTRR' AND KETQUATHI.LANTHI = 1 AND KETQUATHI.KQUA = 'Khong Dat';

--5. * Danh sách học viên (mã học viên, họ tên) của lớp “K” thi môn CTRR không đạt (ở tất cả các lần thi).

SELECT K1.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM KETQUATHI K1, HOCVIEN
WHERE K1.MAHV = HOCVIEN.MAHV AND --DK KET DE LAY HO TEN HOCVIEN
K1.MAMH = 'CTRR' AND K1.LANTHI = (
    SELECT MAX(LANTHI)
    FROM KETQUATHI K2 
    WHERE K1.MAHV = K2.MAHV AND K2.MAMH = 'CTRR'
    --GROUP BY K2.MAHV
)
AND K1.KQUA = 'Khong Dat'

--6. Tìm tên những môn học mà giáo viên có tên “Tran Tam Thanh” dạy trong học kỳ 1 năm 2006.

SELECT DISTINCT MONHOC.TENMH
FROM ((MONHOC 
INNER JOIN GIANGDAY ON MONHOC.MAMH = GIANGDAY.MAMH)
INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV)
WHERE GIAOVIEN.HOTEN = 'Tran Tam Thanh' AND HOCKY = 1 AND NAM = 2006

--7. Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy trong học kỳ 1 năm 2006.

SELECT MONHOC.MAMH, MONHOC.TENMH
FROM MONHOC
INNER JOIN GIANGDAY ON MONHOC.MAMH = GIANGDAY.MAMH
WHERE MAGV = (
                SELECT LOP.MAGVCN
                FROM LOP
                WHERE MALOP = 'K11'
            )
AND HOCKY = 1 AND NAM = 2006

--8. Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So Du Lieu”.

SELECT LOP.TRGLOP, HOCVIEN.HO, HOCVIEN.TEN
FROM ((LOP
INNER JOIN GIANGDAY ON GIANGDAY.MALOP = LOP.MALOP)
INNER JOIN HOCVIEN ON LOP.TRGLOP = HOCVIEN.MAHV)
WHERE GIANGDAY.MAGV = (
                        SELECT GIAOVIEN.MAGV
                        FROM GIAOVIEN
                        WHERE GIAOVIEN.HOTEN = 'Nguyen To Lan'
                    )
AND GIANGDAY.MAMH = (
                        SELECT MONHOC.MAMH
                        FROM MONHOC
                        WHERE MONHOC.TENMH ='Co So Du Lieu'
                    )

--9. In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So Du Lieu”.
    --A LA MON SAU, B LAN MON TRUOC DO
SELECT B.MAMH, B.TENMH
FROM MONHOC A, MONHOC B, DIEUKIEN
WHERE A.MAMH = DIEUKIEN.MAMH AND B.MAMH = DIEUKIEN.MAMH_TRUOC
AND A.TENMH = 'Co So Du Lieu'

--10. Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học, tên môn học) nào.
    --A LA MON sau, B LAN MON TRUOC DO
SELECT A.MAMH, A.TENMH
FROM MONHOC A, MONHOC B, DIEUKIEN
WHERE A.MAMH = DIEUKIEN.MAMH AND B.MAMH = DIEUKIEN.MAMH_TRUOC
AND B.TENMH = 'Cau Truc Roi Rac'

--11 Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1 năm 2006.

SELECT GIAOVIEN.HOTEN
FROM GIAOVIEN 
WHERE GIAOVIEN.MAGV IN (
                        (SELECT GIANGDAY.MAGV
                        FROM GIANGDAY
                        WHERE GIANGDAY.MAMH = 'CTRR' AND GIANGDAY.MALOP = 'K11' AND HOCKY = 1 AND NAM = 2006)

                        INTERSECT

                        (SELECT GIANGDAY.MAGV
                        FROM GIANGDAY
                        WHERE GIANGDAY.MAMH = 'CTRR' AND GIANGDAY.MALOP = 'K12' AND HOCKY = 1 AND NAM = 2006)
                    )

--12. Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng chưa thi lại môn này.

SELECT *
FROM KETQUATHI K1
WHERE K1.MAMH = 'CSDL' AND K1.LANTHI = 1 AND K1.KQUA = 'Khong Dat'
AND 1 = (
    SELECT COUNT(LANTHI)
    FROM KETQUATHI K2
    WHERE K1.MAHV = K2.MAHV AND K2.MAMH = 'CSDL'
    --GROUP BY K2.MAHV, K2.MAMH
)


--13. Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào.

SELECT GIAOVIEN.MAGV, GIAOVIEN.HOTEN
FROM GIAOVIEN
WHERE GIAOVIEN.MAGV IN (
    SELECT GIAOVIEN.MAGV FROM GIAOVIEN
    EXCEPT
    SELECT GIANGDAY.MAGV FROM GIANGDAY
)

--14. Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào thuộc khoa giáo viên đó phụ trách.

SELECT GIAOVIEN.MAGV, GIAOVIEN.HOTEN
FROM GIAOVIEN
WHERE (GIAOVIEN.MAGV+ '' +GIAOVIEN.MAKHOA) NOT IN (
                            (SELECT DISTINCT GIAOVIEN.MAGV+ '' +GIAOVIEN.MAKHOA
                            FROM GIAOVIEN
                            FULL OUTER JOIN MONHOC ON MONHOC.MAKHOA = GIAOVIEN.MAKHOA)
                            INTERSECT
                            (SELECT DISTINCT GIAOVIEN.MAGV+ '' +MONHOC.MAKHOA
                            FROM (GIAOVIEN
                            INNER JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV)
                            INNER JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH)
                        )

SELECT * 
FROM GIAOVIEN
WHERE NOT EXISTS (
    SELECT *
    FROM MONHOC
    WHERE MONHOC.MAKHOA = GIAOVIEN.MAKHOA
    AND EXISTS (
        SELECT *
        FROM GIANGDAY
        WHERE GIANGDAY.MAGV = GIAOVIEN.MAGV AND MONHOC.MAMH = GIANGDAY.MAMH
    )
)

--15. Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat” hoặc thi lần thứ 2 môn CTRR được 5 điểm.

SELECT HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN 
INNER JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE LEFT(HOCVIEN.MAHV, 3) = 'K11' 
AND ((LANTHI > 3 AND KQUA = 'Khong dat' ) OR (LANTHI = 2 AND MAMH = 'CTRR' AND DIEM = 5))

SELECT HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN 
INNER JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE HOCVIEN.MAHV = 'K11__' 
AND ((LANTHI > 3 AND KQUA = 'Khong dat' ) OR (LANTHI = 2 AND MAMH = 'CTRR' AND DIEM = 5))
 
--16. Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm học.

SELECT GIANGDAY.NAM, GIANGDAY.HOCKY, GIANGDAY.MAGV, GIAOVIEN.HOTEN, COUNT(GIANGDAY.MALOP) AS SOLOP
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV AND MaMH = 'CTRR'
GROUP BY GIANGDAY.NAM, GIANGDAY.HOCKY, GIANGDAY.MAGV, GIAOVIEN.HOTEN
HAVING COUNT(*) >= 2

--17. Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng).

SELECT K1.MAHV, K1.LANTHI, K1.DIEM
FROM KETQUATHI K1
WHERE K1.MAMH = 'CSDL' AND K1.LANTHI = (
    SELECT MAX(LANTHI)
    FROM KETQUATHI K2
    WHERE K1.MAHV = K2.MAHV AND K2.MAMH = 'CSDL'
    --GROUP BY K2.MAHV
)


--18. Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần thi).

SELECT K1.MAHV, K1.DIEM
FROM KETQUATHI K1
WHERE K1.MAMH = 'CSDL' AND K1.DIEM = (
    SELECT MAX(DIEM)
    FROM KETQUATHI K2
    WHERE K1.MAHV = K2.MAHV AND K2.MAMH = 'CSDL'
    --GROUP BY K2.MAHV
)

-- 19. Khoa nào (mã khoa, tên khoa) được thành lập sớm nhất.

SELECT TOP 1 WITH TIES MAKHOA, TENKHOA, NGTLAP
FROM KHOA 
ORDER BY NGTLAP ASC

-- 20. Có bao nhiêu giáo viên có học hàm là “GS” hoặc “PGS”.

SELECT HOCHAM, COUNT(MAGV)
FROM GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'
GROUP BY HOCHAM

-- 21. Thống kê có bao nhiêu giáo viên có học vị là “CN”, “KS”, “Ths”, “TS”, “PTS” trong mỗi khoa.

SELECT K.MAKHOA, GV.HOCVI, COUNT(GV.MAGV)
FROM KHOA K, GIAOVIEN GV
WHERE K.MAKHOA = GV.MAKHOA 
GROUP BY K.MAKHOA, GV.HOCVI

-- 22. Mỗi môn học thống kê số lượng học viên theo kết quả (đạt và không đạt).

SELECT KQT.MAMH, KQT.KQUA, COUNT(DISTINCT KQT.MAHV)
FROM KETQUATHI KQT 
GROUP BY KQT.MAMH, KQT.KQUA

-- 23. Tìm giáo viên (mã giáo viên, họ tên) là giáo viên chủ nhiệm của một lớp, đồng thời dạy cho lớp đó ít nhất một môn học.

SELECT DISTINCT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV, LOP L, GIANGDAY GD
WHERE GV.MAGV = L.MAGVCN
AND GD.MAGV = GV.MAGV AND GD.MALOP = L.MALOP

-- 24. Tìm họ tên lớp trưởng của lớp có sỉ số cao nhất.

SELECT HV.HO, HV.TEN
FROM HOCVIEN HV
WHERE HV.MAHV IN (
    SELECT TOP 1 WITH TIES TRGLOP
    FROM LOP 
    ORDER BY SISO DESC
) 

-- 25. * Tìm họ tên những LOPTRG thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả các lần thi).

SELECT DISTINCT K1.MAHV, COUNT( DISTINCT K1.MAMH)
FROM KETQUATHI K1, LOP L
WHERE K1.KQUA = 'Khong Dat' AND L.TRGLOP=K1.MAHV AND K1.LANTHI = (
    SELECT MAX(LANTHI)
    FROM KETQUATHI K2
    WHERE K1.MAHV = K2.MAHV AND K1.MAMH = K2.MAMH
    --GROUP BY K2.MAHV, K2.MAMH
)
GROUP BY K1.MAHV
HAVING COUNT(DISTINCT K1.MAMH) > 3

-- 26. Tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.

SELECT TOP 1 WITH TIES K1.MAHV--, COUNT(K1.MAMH), K1.MAMH, K1.DIEM
FROM KETQUATHI K1
WHERE K1.DIEM IN (9, 9.25, 9.5, 9.75, 10) 
GROUP BY K1.MAHV
ORDER BY COUNT(K1.MAMH) DESC

-- 27. Trong từng lớp, tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.
GO
CREATE VIEW LOP_HVMAX AS (
    SELECT HV.MALOP, K1.MAHV, COUNT(K1.MAMH) AS SLMH--, K1.MAMH, K1.DIEM
    FROM HOCVIEN HV, KETQUATHI K1
    WHERE HV.MAHV = K1.MAHV AND K1.DIEM IN (9, 9.25, 9.5, 9.75, 10) 
    GROUP BY HV.MALOP, K1.MAHV  
)
GO
SELECT A1.MALOP,A1.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN, LOP_HVMAX A1
WHERE A1.MAHV = HOCVIEN.MAHV AND SLMH = (
    SELECT MAX(SLMH)
    FROM LOP_HVMAX A2
    WHERE A2.MALOP = A1.MALOP
    --GROUP BY MALOP
)
DROP VIEW LOP_HVMAX

--C2
SELECT A.MALOP, A.HO, A.TEN, A.SLMH
FROM (
    SELECT HV.MALOP, HV.MAHV, HV.HO, HV.TEN, COUNT(DISTINCT KQ.MAMH) AS SLMH,
        RANK() OVER (PARTITION BY HV.MALOP ORDER BY COUNT(DISTINCT KQ.MAMH) DESC) AS TEMP
    FROM HOCVIEN HV, KETQUATHI KQ
    WHERE HV.MAHV = KQ.MAHV AND KQ.DIEM IN (9, 9.25, 9.5, 9.75, 10)
    GROUP BY HV.MALOP, HV.MAHV, HV.HO, HV.TEN
) AS A 
WHERE A.TEMP = '1'

--28. Trong từng học kỳ của từng năm, mỗi giáo viên phân công dạy bao nhiêu môn học, bao nhiêu lớp.
SELECT GD.NAM, GD.HOCKY, GD.MAGV, COUNT(DISTINCT GD.MAMH) SLMH, COUNT(GD.MALOP) SLLOP
FROM GIANGDAY GD 
GROUP BY GD.NAM, GD.HOCKY, GD.MAGV

--29. Trong từng học kỳ của từng năm, tìm giáo viên (mã giáo viên, họ tên) giảng dạy nhiều nhất.
GO 
CREATE VIEW GD_MAX AS (
    SELECT GD.NAM, GD.HOCKY, GD.MAGV, COUNT(DISTINCT GD.MAMH) SLMH, COUNT(GD.MALOP) SLLOP
    FROM GIANGDAY GD 
    GROUP BY GD.NAM, GD.HOCKY, GD.MAGV
)

GO
SELECT GD1.NAM, GD1.HOCKY, GD1.MAGV
FROM GD_MAX GD1
WHERE SLLOP = (
    SELECT MAX(SLLOP)
    FROM GD_MAX GD2
    WHERE GD2.HOCKY = GD1.HOCKY AND GD2.NAM = GD1.NAM
    --GROUP BY GD2.NAM, GD2.HOCKY
)

DROP VIEW GD_MAX

--C2



SELECT A.NAM, A.HOCKY, A.MAGV, A.HOTEN, A.SL_GD
FROM (
    SELECT GD.NAM, GD.HOCKY, GV.MAGV, GV.HOTEN, COUNT(GD.MALOP) AS SL_GD,
        RANK() OVER (PARTITION BY GD.NAM, GD.HOCKY ORDER BY COUNT(GD.MALOP) DESC) AS TEMP
    FROM GIANGDAY GD, GIAOVIEN GV
    WHERE GD.MAGV = GV.MAGV 
    GROUP BY GD.NAM, GD.HOCKY, GV.MAGV, GV.HOTEN
) AS A 
WHERE A.TEMP = '1'


--30. Tìm môn học (mã môn học, tên môn học) có nhiều học viên thi không đạt (ở lần thi thứ 1) nhất.

SELECT TOP 1 WITH TIES MONHOC.MAMH, MONHOC.TENMH--, COUNT(K1.MAHV) AS HV_KD
FROM MONHOC, KETQUATHI K1
WHERE MONHOC.MAMH = K1.MAMH AND K1.KQUA = 'Khong Dat' AND K1.LANTHI = 1
GROUP BY MONHOC.MAMH, MONHOC.TENMH
ORDER BY COUNT(K1.MAHV) DESC

--31. Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi thứ 1).

SELECT DISTINCT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
AND NOT EXISTS (
    SELECT *
    FROM KETQUATHI
    WHERE MAHV = HOCVIEN.MAHV AND LANTHI = 1 AND KQUA = 'Khong Dat'
)

--32. * Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi sau cùng).

SELECT DISTINCT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN, KETQUATHI K
WHERE HOCVIEN.MAHV = K.MAHV
AND HOCVIEN.MAHV NOT IN ( 
    SELECT K2.MAHV
    FROM KETQUATHI K2, 
    (
        SELECT K1.MAHV, K1.MAMH, MAX(K1.LANTHI) AS LT_MAX
        FROM KETQUATHI K1
        GROUP BY K1.MAHV, K1.MAMH
    ) AS ABC
    WHERE K2.KQUA = 'Khong Dat' AND K2.LANTHI = LT_MAX AND K2.MAHV = ABC.MAHV AND K2.MAMH = ABC.MAMH
)


SELECT DISTINCT HOCVIEN.MAHV, HOCVIEN.HO, HOCVIEN.TEN
FROM HOCVIEN, KETQUATHI K
WHERE HOCVIEN.MAHV = K.MAHV
AND NOT EXISTS ( 
    SELECT *
    FROM KETQUATHI K2, 
    (
        SELECT K1.MAHV, K1.MAMH, MAX(K1.LANTHI) AS LT_MAX
        FROM KETQUATHI K1
        GROUP BY K1.MAHV, K1.MAMH
    ) AS ABC
    WHERE K2.MAHV = K.MAHV AND
    K2.KQUA = 'Khong Dat' AND K2.LANTHI = LT_MAX AND K2.MAHV = ABC.MAHV AND K2.MAMH = ABC.MAMH
)


--33. * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi thứ 1).
SELECT MAHV, HO, TEN
FROM HOCVIEN
WHERE NOT EXISTS (
	SELECT *
	FROM MONHOC
	WHERE NOT EXISTS(
		SELECT *
		FROM KETQUATHI
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND KETQUATHI.MAHV = HOCVIEN.MAHV
			AND LANTHI = 1 AND KQUA = 'Dat'
	)
)


--34. * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi sau cùng).
SELECT MAHV, HO, TEN
FROM HOCVIEN
WHERE NOT EXISTS (
	SELECT *
	FROM MONHOC
	WHERE NOT EXISTS(
		SELECT *
		FROM KETQUATHI
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND KETQUATHI.MAHV = HOCVIEN.MAHV
			AND LANTHI =  (
                SELECT MAX(K3.LANTHI) 
                FROM KETQUATHI K3 
                WHERE K3.MAHV = HOCVIEN.MAHV AND K3.MAMH = MONHOC.MAMH
                --GROUP BY K3.MAHV, K3.MAMH
            ) 
            AND KQUA = 'Dat'
	)
)

SELECT MAX(K3.LANTHI) 
FROM KETQUATHI K3 
WHERE K3.MAHV = 'K1102' AND K3.MAMH = 'CSDL'
--GROUP BY K3.MAHV, K3.MAMH

--35. ** Tìm học viên (mã học viên, họ tên) có điểm thi cao nhất trong từng môn (lấy điểm ở lần thi sau cùng).
GO
CREATE VIEW MH_MAX_DIEM AS (
    SELECT KQ.MAMH, KQ.MAHV, KQ.LANTHI, KQ.DIEM 
    FROM KETQUATHI KQ
    WHERE KQ.LANTHI = (
        SELECT MAX(KQ1.LANTHI) 
        FROM KETQUATHI KQ1 
        WHERE KQ.MAHV = KQ1.MAHV AND KQ.MAMH = KQ1.MAMH --GROUP BY KQ1.MAHV
    )
    --ORDER BY KQ.MAMH, KQ.MAHV ASC
)

GO
SELECT ABC.MAMH, HV.MAHV, HV.HO, HV.TEN, MAX(ABC.DIEM)
FROM HOCVIEN HV, MH_MAX_DIEM ABC
WHERE HV.MAHV = ABC.MAHV
GROUP BY ABC.MAMH, HV.MAHV, HV.HO, HV.TEN
HAVING MAX(ABC.DIEM) = (
    SELECT MAX(MH_MAX_DIEM.DIEM)
    FROM MH_MAX_DIEM
    WHERE MH_MAX_DIEM.MAMH = ABC.MAMH
    --GROUP BY MH_MAX_DIEM.MAMH
)


DROP VIEW MH_MAX_DIEM

--C2:

SELECT A.MAMH, A.MAHV, A.HO, A.TEN 
FROM (
    SELECT KQ.MAMH, HV.MAHV, HV.HO, HV.TEN, KQ.DIEM,
        RANK() OVER (PARTITION BY KQ.MAMH ORDER BY KQ.DIEM DESC) AS TEMP
    FROM HOCVIEN HV, KETQUATHI KQ
    WHERE HV.MAHV = KQ.MAHV AND KQ.LANTHI = (
        SELECT MAX(LANTHI) 
        FROM KETQUATHI KQ1
        WHERE KQ1.MAHV = HV.MAHV AND KQ.MAMH = KQ1.MAMH
    )
) AS A 
WHERE A.TEMP = '1'